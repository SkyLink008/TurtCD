<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TurtCD ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --accent:#06b6d4;
    --accent-2:#8b5cf6;
    --card:#0b1226;
    --muted:#94a3b8;
    --white:#ffffff;
    --success:#10b981;
    --danger:#ef4444;
    --panel-width:300px;
  }
  
  /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
  [data-theme="light"] {
    --bg:#f8fafc;
    --panel:#ffffff;
    --accent:#0ea5e9;
    --accent-2:#6366f1;
    --card:#ffffff;
    --muted:#64748b;
    --white:#1e293b;
    --success:#059669;
    --danger:#dc2626;
  }
  
  [data-theme="light"] body {
    background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    color: var(--white);
  }
  
  [data-theme="light"] .left,
  [data-theme="light"] .right-panel {
    background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] .center {
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    background: linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
  }
  
  [data-theme="light"] .toolbar {
    border-bottom: 1px solid rgba(0,0,0,0.1);
    background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
  }
  
  [data-theme="light"] .block {
    background: var(--card);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  }
  
  [data-theme="light"] .block:hover {
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  
  [data-theme="light"] .block-header {
    background: linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.02));
    color: var(--white);
  }
  
  [data-theme="light"] .block-content {
    background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00));
  }
  
  [data-theme="light"] .field-input {
    background: rgba(0,0,0,0.05);
    color: var(--white);
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  
  [data-theme="light"] .category-header {
    background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent);
  }
  
  [data-theme="light"] .category-header:hover {
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  }
  
  [data-theme="light"] .block-item {
    background: linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] .block-item:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }
  
  /* Force white text on canvas blocks in light theme for readability */
  [data-theme="light"] .block,
  [data-theme="light"] .block-header,
  [data-theme="light"] .block-content,
  [data-theme="light"] .block .small,
  [data-theme="light"] .block .block-name {
    color: #ffffff !important;
  }
  [data-theme="light"] .field-input {
    color: #ffffff !important;
  }
  
  /* Force white text in context menu (right-click) under light theme */
  [data-theme="light"] #blockContextMenu .menu-item {
    color: #ffffff !important;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#071025 0%,#0b1220 100%); color:var(--white); -webkit-font-smoothing:antialiased}
  .app { display:flex; height:100vh; gap:16px; padding:16px; }
  .left {
    width:var(--panel-width);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; box-shadow:0 8px 30px rgba(2,6,23,0.6); overflow:auto;
  }
  .left h2 { margin:0 0 12px; font-size:18px; letter-spacing:0.2px; color:var(--white); }
  .category-header { display:flex; justify-content:space-between; align-items:center; padding:8px; cursor:pointer; border-radius:8px; margin-top:8px; transition:all .18s; background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent); }
  .category-header:hover { transform:translateY(-3px); box-shadow:0 6px 18px rgba(2,6,23,0.45); }
  .category-title { font-weight:600; color:#e6eef6; }
  [data-theme="light"] .category-title { font-weight:600; color:#1e293b; }
  .collapse-indicator { opacity:0.7; font-size:12px; }
  .block-list { display:grid; gap:8px; margin-top:8px; padding-bottom:12px; }
  .block-item { display:flex; gap:8px; align-items:center; padding:10px; border-radius:10px; cursor:grab; user-select:none;
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03);
    transition:transform .12s, box-shadow .12s; }
  .block-item:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.55); }
  .color-dot { width:14px; height:14px; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.12); }
  .block-name { font-size:13px; color:#e6eef6; font-weight:600; }
  [data-theme="light"] .block-name { font-size:13px; color:#1e293b; font-weight:600; }

  .center {
    flex:1; position:relative; overflow:hidden; border-radius:12px; box-shadow:0 10px 40px rgba(2,6,23,0.6);
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));
    display:flex; flex-direction:column;
  }
  .toolbar { display:flex; gap:10px; padding:12px; align-items:center; border-bottom:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); }
  .btn { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#022; padding:8px 12px; border-radius:10px; border:none; font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(14,165,233,0.08); transition:transform .12s; }
  .btn:hover { transform:translateY(-3px); }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--white); padding:8px 10px; border-radius:10px; cursor:pointer; }
  
  /* –°–µ–ª–µ–∫—Ç–æ—Ä —Ç–µ–º */
  .theme-selector {
    display: flex;
    gap: 4px;
    align-items: center;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 4px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .theme-option {
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    background: transparent;
    color: var(--muted);
  }
  
  .theme-option.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 8px rgba(14,165,233,0.3);
  }
  
  .theme-option:hover:not(.active) {
    background: rgba(255,255,255,0.1);
    color: var(--white);
  }
  
  [data-theme="light"] .theme-selector {
    background: rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] .theme-option {
    color: var(--muted);
  }
  
  [data-theme="light"] .theme-option:hover:not(.active) {
    background: rgba(0,0,0,0.1);
    color: var(--white);
  }

  .workspace { position:relative; flex:1; overflow:hidden; display:flex; }
  #viewport { position:relative; flex:1; overflow:hidden; }
  #mainCanvas { position:absolute; left:0; top:0; width:16000px; height:16000px; transform:translate(0px,0px) scale(1); transition:transform .08s linear; }
  .block { position:absolute; min-width:140px; border-radius:12px; color:var(--white); background:var(--card); box-shadow: 0 12px 30px rgba(2,6,23,0.6); overflow:visible; transform-origin:left top; transition:box-shadow .12s, transform .08s; }
  .block:hover { box-shadow:0 20px 60px rgba(2,6,23,0.75); transform:translateY(-4px); }
  .block-warning { outline: 2px solid #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25), 0 14px 36px rgba(245, 158, 11, 0.25) !important; }
  .block-error { outline: 2px solid #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.30), 0 14px 36px rgba(239, 68, 68, 0.30) !important; }
  .block-indicator { position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%; display:none; align-items:center; justify-content:center; font-weight:800; font-size:13px; color:#0b1220; z-index:70; box-shadow:0 6px 14px rgba(0,0,0,0.25); }
  .indicator-warning { background:#f59e0b; color:#1f2937; }
  .indicator-error { background:#ef4444; color:#fff; }
  .block-header { padding:12px; font-weight:800; letter-spacing:0.2px; font-size:14px; background:linear-gradient(90deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02)); cursor:move; -webkit-user-select:none; -moz-user-select:none; user-select:none; color: var(--white); }
  .block-content { padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); min-height:36px; display:flex; flex-direction:column; gap:8px; }
  .field-input { padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.15); font-size:13px; background:rgba(255,255,255,0.96); color:#0b1220 }

  /* —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
  .connector, .connection-line, .connection-point { -webkit-user-select:none; -moz-user-select:none; user-select:none; }
  .temp-line { pointer-events:none; }

  .connector { position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; border:2px solid rgba(0,0,0,0.5); z-index:60; }
  .connector-top{ top:-10px; left:50%; transform:translateX(-50%); }
  .connector-bottom{ bottom:-10px; left:50%; transform:translateX(-50%); }
  .connector-right{ top:50%; right:-10px; transform:translateY(-50%); }
  .connector-left{ top:50%; left:-10px; transform:translateY(-50%); }

  .connection-line{ position:absolute; height:4px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transform-origin:0 0; z-index:40; border-radius:6px; box-shadow:0 6px 16px rgba(11,20,40,0.3); }
  .connection-point{ position:absolute; width:12px; height:12px; border-radius:50%; background:var(--success); z-index:45; box-shadow:0 6px 16px rgba(16,185,129,0.12); cursor:context-menu; }

  .right-panel { width:300px; background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border-radius:12px; padding:12px; box-shadow:0 8px 40px rgba(2,6,23,0.6); }
  .panel-title { font-weight:800; margin-bottom:10px }
  .small { font-size:13px; color:var(--muted) }
  
  /* –í–∫–ª–∞–¥–∫–∏ –ø–∞–Ω–µ–ª–∏ */
  .panel-tabs {
    display: flex;
    margin-bottom: 12px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 4px;
  }
  
  .tab-button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: var(--muted);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .tab-button.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 8px rgba(14,165,233,0.3);
  }
  
  .tab-button:hover:not(.active) {
    background: rgba(255,255,255,0.1);
    color: var(--white);
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  
  
  /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã–µ –æ–∫–Ω–∞ */
  .custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  
  .custom-modal-content {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    min-width: 400px;
    max-width: 600px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .custom-modal-header {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--white);
  }
  
  .custom-modal-body {
    margin-bottom: 20px;
  }
  
  .custom-modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .custom-input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: var(--white);
    font-size: 14px;
    margin-bottom: 12px;
  }
  
  .custom-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6,182,212,0.1);
  }
  
  .custom-input::placeholder {
    color: var(--muted);
  }
  
  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 10001;
    min-width: 300px;
    max-width: 400px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  
  .notification.show {
    transform: translateX(0);
  }
  
  .notification.success {
    border-left: 4px solid var(--success);
  }
  
  .notification.error {
    border-left: 4px solid var(--danger);
  }
  
  .notification-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }
  
  .notification-icon {
    font-size: 20px;
  }
  
  .notification-title {
    font-weight: 600;
    color: var(--white);
    font-size: 16px;
  }
  
  .notification-message {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.4;
  }
  
  .notification-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  
  .notification-close:hover {
    background: rgba(255,255,255,0.1);
    color: var(--white);
  }
  

  /* –º–æ–¥—É–ª—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π/–æ—à–∏–±–æ–∫ */
  .issues-container { margin-top:12px; max-height:320px; overflow:auto; padding-right:6px; }
  .issue {
    display:flex; gap:8px; align-items:flex-start; padding:10px; border-radius:8px; margin-bottom:8px;
    font-size:13px; line-height:1.2;
  }
  .issue .icon {
    min-width:20px; min-height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800;
    flex-shrink:0;
  }
  .issue.warning { background: rgba(74, 63, 12, 0.12); color: #5a4e07; transition: all 0.2s ease; }
  .issue.warning:hover { background: rgba(74, 63, 12, 0.2); transform: translateY(-1px); }
  .issue.warning .icon { background: #4f3700; color: #ffd54a; width:26px; height:26px; border-radius:4px; display:flex; align-items:center; justify-content:center; }
  .issue.error { background: rgba(139, 0, 0, 0.08); color: #7a1515; transition: all 0.2s ease; }
  .issue.error:hover { background: rgba(139, 0, 0, 0.15); transform: translateY(-1px); }
  .issue.error .icon { background: #7a1515; color: #ffccd5; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

  /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Å–∫—É—Ä—Å–∞ */
  .help-tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    pointer-events: none;
  }

  .help-tour-spotlight {
    position: absolute;
    border: 3px solid var(--accent);
    border-radius: 12px;
    background: rgba(6, 182, 212, 0.1);
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 30px rgba(6, 182, 212, 0.8), inset 0 0 20px rgba(6, 182, 212, 0.2);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 10001;
  }

  .help-tour-tooltip {
    position: absolute;
    background: var(--card);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 350px;
    z-index: 10001;
    pointer-events: auto;
    animation: helpTooltipAppear 0.3s ease;
  }

  @keyframes helpTooltipAppear {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .help-tour-tooltip h3 {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--white);
  }

  .help-tour-tooltip p {
    margin: 0 0 16px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--muted);
  }

  .help-tour-tooltip .help-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .help-tour-tooltip .btn {
    padding: 8px 16px;
    font-size: 13px;
  }

  .help-tour-tooltip .btn-ghost {
    padding: 8px 16px;
    font-size: 13px;
  }

  .help-tour-progress {
    position: absolute;
    bottom: 12px;
    left: 20px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }

  /* –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .help-tour-highlighted {
    position: relative;
    z-index: 10002 !important;
    transform: scale(1.02);
    transition: all 0.3s ease;
  }

  @media (max-width:1100px){ .left{display:none} .right-panel{display:none} }

  body {
    font-family: monospace !important;
    font-size: 18px !important;
  }
  button, .button, input[type=button], input[type=submit] {
    font-family: monospace !important;
    font-size: 16px !important;
  }
</style>
</head>
<body>
  <div class="app">

    <!-- Left palette -->
    <div class="left">
      <h2>–ü–∞–ª–∏—Ç—Ä–∞ –±–ª–æ–∫–æ–≤</h2>
      <div id="categoriesList"></div>

      <div style="height:8px"></div>
      <div style="display:flex; gap:8px;">
        <button class="btn" onclick="exportProject()">‚¨á –≠–∫—Å–ø–æ—Ä—Ç (.turtcd)</button>
        <button class="btn" onclick="saveProject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      
      <div style="height:8px"></div>
      <button class="btn-ghost" onclick="clearWorkspace()" style="width:100%; color:var(--danger); border-color:var(--danger);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>

      <div style="height:12px"></div>
      <input id="importFile" type="file" accept=".turtcd,application/json" style="display:none" onchange="importFromFile(event)"/>
      <button class="btn-ghost" onclick="document.getElementById('importFile').click()">‚¨Ü –ò–º–ø–æ—Ä—Ç (.turtcd)</button>

      <div style="height:12px"></div>
      <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∏: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –±–ª–æ–∫–∏ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã –Ω–∞ –ø–æ–ª–µ. Ctrl + –õ–ö–ú ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã. –ü–ö–ú –Ω–∞ –±–ª–æ–∫ ‚Äî –º–µ–Ω—é.</div>
    </div>

    <!-- Center area -->
    <div class="center">
      <div class="toolbar">
        <button class="btn" onclick="compileProject()">‚ñ∂ –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn-ghost" onclick="goToProjectSelection()">üè† –ú–µ–Ω—é</button>
        <button class="btn-ghost" onclick="startHelpTour()">‚ùì –ü–æ–º–æ—â—å</button>
        <div style="flex:1"></div>
        <div class="theme-selector">
          <button class="theme-option active" onclick="setTheme('dark')">üåô –¢—ë–º–Ω–∞—è</button>
          <button class="theme-option" onclick="setTheme('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
        </div>
      </div>

      <div class="workspace" id="workspace">
        <div id="viewport" style="flex:1; position:relative; overflow:hidden">
          <div id="mainCanvas"></div>
        </div>
      </div>
    </div>

    <!-- Right info panel -->
    <div class="right-panel">
      <div class="panel-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
      <div><strong>–ë–ª–æ–∫–∏:</strong> <span id="blocksCount">0</span></div>
      <div><strong>–°–≤—è–∑–∏:</strong> <span id="connsCount">0</span></div>
      <div style="height:12px"></div>
      <div class="small">–ò—Å–ø–æ–ª—å–∑—É–π ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, ¬´–≠–∫—Å–ø–æ—Ä—Ç¬ª ‚Äî —Å–∫–∞—á–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ .turtcd</div>

      <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ -->
      <div id="issuesPanel" class="issues-container" aria-live="polite"></div>
    </div>
  </div>

  <!-- Context menu for blocks -->
  <div id="blockContextMenu" style="position:absolute; display:none; z-index:20000;">
    <div style="background:#071025; padding:8px; border-radius:8px; box-shadow:0 8px 28px rgba(2,6,23,0.6); min-width:160px;">
      <div class="menu-item" style="padding:8px; cursor:pointer;" onclick="duplicateContextBlock()">üìÑ –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</div>
      <div class="menu-item" style="padding:8px; cursor:pointer; color:var(--danger);" onclick="deleteContextBlock()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
    </div>
  </div>


  <!-- Save modal -->
  <div id="saveModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
        <div style="margin-bottom:8px">–ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):</div>
        <input id="saveFilename" class="input" placeholder="–º–æ–π_–ø—Ä–æ–µ–∫—Ç">
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" onclick="saveToServer()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn-ghost" onclick="closeSaveModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Server list modal -->
  <div id="serverModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–ü—Ä–æ–µ–∫—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h3>
        <div id="serverList" style="max-height:280px; overflow:auto; margin-top:8px"></div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeServerModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== State ========== */
let blocksConfig = { categories: [] };
let projectData = { blocks: [], connections: [] };

let dragState = null;           // dragging a block element
let connecting = null;          // creating connection {blockEl, connEl, startX, startY, tempLine}
let camera = { x: 0, y: 0, scale: 1 };    // camera translation
let isPanning = false;
let panStart = null;
let panCameraStart = null;
let contextBlockEl = null;

/* ========== Utils ========== */
function genId(){ return 'b-' + Math.random().toString(36).slice(2,10); }
function el(tag, attrs={}, ...children){
  const e=document.createElement(tag);
  for(const k in attrs){
    if(k === 'className') e.className = attrs[k];
    else if(k === 'onclick') e.setAttribute('onclick', attrs[k]);
    else e[k]=attrs[k];
  }
  children.flat().forEach(c=> typeof c === 'string'? e.appendChild(document.createTextNode(c)) : e.appendChild(c));
  return e;
}
function updateCamera(){ mainCanvas.style.transform = `translate(${camera.x}px,${camera.y}px) scale(${camera.scale})`; }

/* ========== Load blocks config (from server) & render palette ========== */
async function loadBlocksConfig(){
  try {
    const r = await fetch('/api/blocks');
    blocksConfig = await r.json();
  } catch(err){
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å /api/blocks', err);
    // fallback example config so UI is usable
    blocksConfig = {
      categories: [
        { name: '–û—Å–Ω–æ–≤–Ω—ã–µ', collapsed: false, blocks: [
          { id: 'start', name: 'Start', color: '#0ea5a4', type: 'header', width: 220, height: 60, fields: [] },
          { id: 'print', name: 'Print', color: '#8b5cf6', type: 'classic', width: 160, height: 80, fields: [{ name: 'text', label: 'Text' }] },
        ] }
      ]
    };
  }
  renderPalette();
}
function renderPalette(){
  const root = document.getElementById('categoriesList');
  root.innerHTML = '';
  blocksConfig.categories.forEach(cat=>{
    const header = el('div',{className:'category-header'}, el('div',{className:'category-title'}, cat.name), el('div',{className:'collapse-indicator'}, cat.collapsed ? '‚ñ∂' : '‚ñº'));
    const list = el('div',{className:'block-list'});
    if(cat.collapsed) list.style.display='none';
    header.addEventListener('click', ()=>{
      list.style.display = list.style.display === 'none' ? 'block' : 'none';
      const ind = header.querySelector('.collapse-indicator');
      ind.textContent = list.style.display === 'none' ? '‚ñ∂' : '‚ñº';
    });
    cat.blocks.forEach(b=>{
      const item = el('div',{className:'block-item', draggable:true});
      item.dataset.templateId = b.id;
      const dot = el('span',{className:'color-dot'});
      dot.style.background = b.color || '#7f8c8d';
      const name = el('div',{className:'block-name'}, b.name);
      item.appendChild(dot); item.appendChild(name);
      // click create (center-ish)
      item.addEventListener('click', ()=> createFromTemplate(b.id, 200 - camera.x, 200 - camera.y));
      // dragstart - use text/plain for compatibility
      item.addEventListener('dragstart', (ev)=> {
        ev.dataTransfer.setData('text/plain', b.id);
        ev.dataTransfer.effectAllowed = 'copy';
      });
      list.appendChild(item);
    });
    root.appendChild(header);
    root.appendChild(list);
  });
}

/* ========== Canvas & block creation ========== */
const mainCanvas = document.getElementById('mainCanvas');

function createFromTemplate(templateId, x, y){
  const cfg = findCfg(templateId); if(!cfg) return;
  const id = genId();
  const block = {
    id, template: cfg.id, type: cfg.type,
    x: Math.round(x), y: Math.round(y),
    width: cfg.width || 160, height: cfg.height || 80,
    fields: {}
  };
  if(cfg.fields) cfg.fields.forEach(f => block.fields[f.name] = '');
  projectData.blocks.push(block);
  createInstance(block);
  updateCounts();
  updateConnections();
}
function findCfg(templateId){
  for(const cat of blocksConfig.categories) for(const b of cat.blocks) if(b.id===templateId) return b;
  return null;
}

function createInstance(blockData){
  const cfg = findCfg(blockData.template);
  const wrapper = el('div', { className: 'block' });
  wrapper.style.left = blockData.x + 'px';
  wrapper.style.top = blockData.y + 'px';
  wrapper.style.background = cfg?.color || '#2a4f6b';
  wrapper.dataset.blockId = blockData.id;
  wrapper.dataset.blockType = blockData.type || (cfg && cfg.type) || 'classic';

  const header = el('div', { className: 'block-header' }, cfg?.name || ('Block ' + blockData.template));
  const content = el('div', { className: 'block-content' });

  // indicator (top-right)
  const indicator = el('div', { className: 'block-indicator' });
  indicator.setAttribute('aria-hidden', 'true');

  if(cfg && cfg.fields && cfg.fields.length){
    cfg.fields.forEach(f=>{
      const input = el('input', { className: 'field-input', placeholder: f.placeholder || f.label || f.name, value: blockData.fields[f.name] || '' });
      input.addEventListener('input', (e)=> {
        blockData.fields[f.name] = e.target.value;
        // –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è
        updateCounts();
      });
      content.appendChild(input);
    });
  } else {
    content.appendChild(el('div',{className:'small'}, cfg?.type || ''));
  }

  // connectors
  if(!cfg || cfg.type !== 'header') wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-top' }));
  wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-bottom' }));
  if(cfg && (cfg.type === 'condition' || cfg.type === 'loop')) wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-right' }));

  wrapper.appendChild(indicator);
  wrapper.appendChild(header);
  wrapper.appendChild(content);

  // drag move block (start only when click NOT on input and NOT on connector)
  wrapper.addEventListener('mousedown', (ev)=>{
    // if user clicked on input or contenteditable or on connector - don't start move
    const target = ev.target;
    if(target.closest('input,textarea,[contenteditable="true"]')) return;
    if(target.closest('.connector')) return;
    // start dragging
    document.body.style.userSelect = 'none';
    const rect = wrapper.getBoundingClientRect();
    dragState = { el: wrapper, startX: ev.clientX, startY: ev.clientY, left: parseFloat(wrapper.style.left || 0), top: parseFloat(wrapper.style.top || 0) };
  });

  mainCanvas.appendChild(wrapper);
}

/* ========== Drag move handler & camera ========== */
document.addEventListener('mousemove', (e)=>{
  // dragging a block
  if(dragState){
    const dx = e.clientX - dragState.startX, dy = e.clientY - dragState.startY;
    const nx = dragState.left + dx, ny = dragState.top + dy;
    dragState.el.style.left = nx + 'px'; dragState.el.style.top = ny + 'px';
    const bid = dragState.el.dataset.blockId;
    const bd = projectData.blocks.find(b => b.id === bid);
    if(bd){ bd.x = nx; bd.y = ny; }
    updateConnections();
    return; // when dragging block don't pan or update connecting line separately here
  }

  // panning camera
  if(isPanning){
    const dx = e.clientX - panStart.x, dy = e.clientY - panStart.y;
    camera.x = panCameraStart.x + dx; camera.y = panCameraStart.y + dy;
    updateCamera();
    updateConnections();
    return;
  }

  // updating connecting temp-line
  if(connecting){
    const rect = mainCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const dx = mx - connecting.startX, dy = my - connecting.startY;
    const len = Math.sqrt(dx*dx + dy*dy);
    const ang = Math.atan2(dy,dx);
    connecting.tempLine.style.width = Math.max(len,2) + 'px';
    connecting.tempLine.style.transform = `rotate(${ang}rad)`;
  }
});

// mouseup / end interactions
document.addEventListener('mouseup', (e)=>{
  // stop dragging
  dragState = null;
  // stop panning
  isPanning = false;
  panStart = null;
  panCameraStart = null;

  // cleanup connecting if not finished (if there is a connecting temporary line and mouseup outside connector)
  if(connecting && connecting.tempLine){
    connecting.tempLine.remove();
    connecting = null;
  }
  // restore selection
  document.body.style.userSelect = '';
});

// when leaving viewport, cancel panning
document.getElementById('viewport').addEventListener('mouseleave', ()=>{
  isPanning = false;
  panStart = null;
  panCameraStart = null;
});

/* ========== Connecting blocks (temp line & finalize) ========== */
mainCanvas.addEventListener('mousedown', (e)=>{
  const conn = e.target.closest('.connector');
  if(!conn) return;
  e.preventDefault();
  // disable text selection while creating connection
  document.body.style.userSelect = 'none';
  const blockEl = conn.closest('.block');
  const crect = conn.getBoundingClientRect(), canv = mainCanvas.getBoundingClientRect();
  const startX = crect.left + crect.width/2 - canv.left;
  const startY = crect.top + crect.height/2 - canv.top;
  const tempLine = document.createElement('div');
  tempLine.className = 'connection-line temp-line';
  tempLine.style.left = startX + 'px';
  tempLine.style.top = startY + 'px';
  tempLine.style.width = '0px';
  tempLine.style.transform = 'rotate(0rad)';
  mainCanvas.appendChild(tempLine);
  connecting = { blockEl, connEl: conn, startX, startY, tempLine };
});
mainCanvas.addEventListener('mouseup', (e)=>{
  if(!connecting) return;
  const targetConn = e.target.closest('.connector');
  if(targetConn){
    const toBlock = targetConn.closest('.block');
    if(toBlock && toBlock !== connecting.blockEl){
      const fromId = connecting.blockEl.dataset.blockId, toId = toBlock.dataset.blockId;
      const fromC = connectorType(connecting.connEl), toC = connectorType(targetConn);
      if(allowedConnect(fromC, toC)){
        projectData.connections.push({ from: fromId, to: toId, fromConnector: fromC, toConnector: toC });
        updateConnections();
      }
    }
  }
  // cleanup temp
  if(connecting?.tempLine) connecting.tempLine.remove();
  connecting = null;
  // restore selection
  document.body.style.userSelect = '';
});

/* connector helpers */
function connectorType(el){
  if(el.classList.contains('connector-top')) return 'top';
  if(el.classList.contains('connector-bottom')) return 'bottom';
  if(el.classList.contains('connector-right')) return 'right';
  if(el.classList.contains('connector-left')) return 'left';
  return '';
}
function allowedConnect(from, to){ return (['bottom','right'].includes(from) && ['top','left'].includes(to)); }

/* ========== Render connections ========== */
function updateConnections(){
  // remove old visuals (except temp-line)
  mainCanvas.querySelectorAll('.connection-line:not(.temp-line), .connection-point').forEach(n=>n.remove());
  // iterate
  projectData.connections.forEach(c=>{
    const fromEl = mainCanvas.querySelector(`.block[data-block-id="${c.from}"]`);
    const toEl = mainCanvas.querySelector(`.block[data-block-id="${c.to}"]`);
    if(!fromEl || !toEl) return;
    const fromConn = fromEl.querySelector(`.connector-${c.fromConnector}`);
    const toConn = toEl.querySelector(`.connector-${c.toConnector}`);
    if(!fromConn || !toConn) return;
    const p1 = connectorCenterInCanvas(fromConn);
    const p2 = connectorCenterInCanvas(toConn);
    const dx = p2.x - p1.x, dy = p2.y - p1.y;
    const len = Math.sqrt(dx*dx + dy*dy), ang = Math.atan2(dy,dx);
    const line = document.createElement('div'); line.className = 'connection-line';
    line.style.left = p1.x + 'px'; line.style.top = p1.y + 'px';
    line.style.width = Math.max(len,2) + 'px'; line.style.transform = `rotate(${ang}rad)`;
    // attach dataset for identification
    line.dataset.key = `${c.from}->${c.to}:${c.fromConnector}->${c.toConnector}`;
    mainCanvas.appendChild(line);
    // mid point clickable for deletion
    const mx = p1.x + dx/2, my = p1.y + dy/2;
    const point = document.createElement('div'); point.className = 'connection-point';
    point.style.left = (mx - 6) + 'px'; point.style.top = (my - 6) + 'px';
    point.dataset.key = line.dataset.key;
    point.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); // remove connection
      const key = ev.currentTarget.dataset.key;
      projectData.connections = projectData.connections.filter(cc => `${cc.from}->${cc.to}:${cc.fromConnector}->${cc.toConnector}` !== key);
      updateConnections();
      updateCounts();
    });
    mainCanvas.appendChild(point);
  });
  updateCounts();
}
function connectorCenterInCanvas(connEl){
  const r = connEl.getBoundingClientRect(), c = mainCanvas.getBoundingClientRect();
  return { x: r.left + r.width/2 - c.left, y: r.top + r.height/2 - c.top };
}

/* ========== Camera pan (Ctrl + LMB) ========== */
document.getElementById('viewport').addEventListener('mousedown', (e)=>{
  // start panning with Ctrl + LMB
  if(e.button===0 && e.ctrlKey){
    isPanning = true;
    panStart = { x: e.clientX, y: e.clientY };
    panCameraStart = { x: camera.x, y: camera.y };
    e.preventDefault();
  }
});
window.addEventListener('keyup', (e)=>{ if(e.key === 'Control') { isPanning = false; panStart = null; panCameraStart = null; } });

/* ========== Drag & Drop from palette anywhere on page ========== */
document.addEventListener('dragover', (e)=> e.preventDefault());
document.addEventListener('drop', (e)=>{
  e.preventDefault();
  // read template id (support both text/plain and legacy templateId)
  const templateId = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('templateId');
  if(!templateId) return;
  // position adjusted with camera transform (camera.x, camera.y)
  const viewportRect = document.getElementById('viewport').getBoundingClientRect();
  const vx = e.clientX - viewportRect.left;
  const vy = e.clientY - viewportRect.top;
  const x = vx - camera.x;
  const y = vy - camera.y;
  createFromTemplate(templateId, x, y);
  updateConnections();
});

/* ========== Context menu actions ========== */
document.addEventListener('contextmenu', (e)=>{
  const block = e.target.closest('.block');
  const menu = document.getElementById('blockContextMenu');
  if(block){
    e.preventDefault();
    contextBlockEl = block;
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.style.display = 'block';
  } else {
    menu.style.display = 'none';
    contextBlockEl = null;
  }
});
document.addEventListener('click', ()=> { document.getElementById('blockContextMenu').style.display='none'; });

async function duplicateContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  const bd = projectData.blocks.find(b => b.id === id);
  if(!bd) return;
  try {
    const resp = await fetch('/api/block/duplicate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ block_data: bd })});
    const j = await resp.json();
    if(j.status === 'success' && j.new_block){
      projectData.blocks.push(j.new_block);
      createInstance(j.new_block);
      updateConnections();
      updateCounts();
    } else alert('–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
  } catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è'); }
  document.getElementById('blockContextMenu').style.display='none';
}

function deleteContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  projectData.blocks = projectData.blocks.filter(b => b.id !== id);
  projectData.connections = projectData.connections.filter(c => c.from !== id && c.to !== id);
  const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
  if(el) el.remove();
  updateConnections();
  updateCounts();
  document.getElementById('blockContextMenu').style.display='none';
}

/* ========== Export / Import / Save to server / Load from server ========== */
function exportProject(){
  const data = JSON.stringify(projectData, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const fname = 'project.turtcd';
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function saveProject(){
  const currentProject = localStorage.getItem('currentProject');
  if (!currentProject) {
    showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç.');
    return;
  }
  
  try {
    const resp = await fetch('/api/project/save-file', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ 
        filename: currentProject, 
        project_data: projectData 
      })
    });
    const j = await resp.json();
    if(j.status === 'success') { 
      showNotification('success', '–£—Å–ø–µ—Ö', '–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ' + currentProject);
    } else {
      showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (j.message || 'unknown'));
    }
  } catch(err){ 
    showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
  }
}

function importFromFile(ev){
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const parsed = JSON.parse(e.target.result);
      if(parsed && parsed.blocks){
        loadProjectFromObject(parsed);
      } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
    } catch(err){ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message); }
  };
  reader.readAsText(f);
  // reset
  ev.target.value = '';
}

function loadProjectFromObject(obj){
  // clear canvas
  mainCanvas.querySelectorAll('.block').forEach(n=>n.remove());
  projectData = obj;
  // create instances
  projectData.blocks.forEach(b => createInstance(b));
  updateConnections();
  updateCounts();
}

/* Server save modal */
function openSaveModal(){ document.getElementById('saveModal').style.display = 'block'; }
function closeSaveModal(){ document.getElementById('saveModal').style.display = 'none'; }
async function saveToServer(){
  const filename = document.getElementById('saveFilename').value.trim();
  if(!filename){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞'); return; }
  try {
    const resp = await fetch('/api/project/save-file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: filename + '.turtcd', project_data: projectData })});
    const j = await resp.json();
    if(j.status === 'success') { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + j.filename); closeSaveModal(); }
    else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message); }
}

/* Server list */
async function showServerProjects(){
  try {
    const r = await fetch('/api/project/list');
    const j = await r.json();
    if(j.status !== 'success'){ alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞'); return; }
    const listDiv = document.getElementById('serverList');
    listDiv.innerHTML = '';
    if(j.projects.length === 0) listDiv.appendChild(el('div', {}, '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤'));
    j.projects.forEach(fn => {
      const row = el('div', {}, fn);
      row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center'; row.style.padding = '6px 0';
      const btn = document.createElement('button');
      btn.className = 'btn-ghost';
      btn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
      btn.addEventListener('click', ()=> loadProjectFromServer(fn));
      row.appendChild(btn);
      listDiv.appendChild(row);
    });
    document.getElementById('serverModal').style.display = 'block';
  } catch(err){ alert('–û—à–∏–±–∫–∞: ' + err.message); }
}
function closeServerModal(){ document.getElementById('serverModal').style.display = 'none'; }
async function loadProjectFromServer(filename){
  try {
    const resp = await fetch('/api/project/load-file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename })});
    const j = await resp.json();
    if(j.status === 'success' && j.project_data){
      loadProjectFromObject(j.project_data);
      closeServerModal();
    } else alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message); }
}

/* ========== Compile ========== */
async function compileProject(){
  try {
    const resp = await fetch('/api/project/compile', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ project_data: projectData })
    });
    const j = await resp.json();
    if(j.status === 'success'){
      localStorage.setItem("compiled_code", j.code || "# –ø—É—Å—Ç–æ");
      window.location.href = "/compiled.html";
    } else alert('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: ' + err.message); }
}

/* ========== –ü—Ä–æ–≤–µ—Ä–∫–∏: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏ ========== */
function updateIssues(){
  const panel = document.getElementById('issuesPanel');
  if(!panel) return;
  panel.innerHTML = '';
  // clear previous highlights
  mainCanvas.querySelectorAll('.block').forEach(el=>{ el.classList.remove('block-warning','block-error'); });
  // clear previous indicators
  mainCanvas.querySelectorAll('.block .block-indicator').forEach(ind=>{ ind.style.display='none'; ind.classList.remove('indicator-warning','indicator-error'); ind.textContent=''; });

  // collect per-block statuses
  const warningBlocks = new Set();
  const errorBlocks = new Set();

  // Helper to create styled message blocks
  function addWarning(text, blockId = null){
    const node = document.createElement('div');
    node.className = 'issue warning';
    if(blockId) {
      node.style.cursor = 'pointer';
      node.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É';
    }
    const ic = document.createElement('div'); ic.className = 'icon'; ic.textContent = '!';
    node.appendChild(ic);
    const txt = document.createElement('div'); txt.textContent = '–ù–ï–°–û–û–¢–í–ï–¢–°–í–ò–ï! ' + text;
    node.appendChild(txt);
    if(blockId) {
      node.addEventListener('click', () => moveCameraToBlock(blockId));
    }
    panel.appendChild(node);
  }
  function addError(text, blockId = null){
    const node = document.createElement('div');
    node.className = 'issue error';
    if(blockId) {
      node.style.cursor = 'pointer';
      node.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É';
    }
    const ic = document.createElement('div'); ic.className = 'icon'; ic.textContent = '‚úï';
    node.appendChild(ic);
    const txt = document.createElement('div'); txt.textContent = '–û–®–ò–ë–ö–ê! ' + text;
    node.appendChild(txt);
    if(blockId) {
      node.addEventListener('click', () => moveCameraToBlock(blockId));
    }
    panel.appendChild(node);
  }

  // 1) Empty input fields -> warning per field
  projectData.blocks.forEach(b=>{
    const cfg = findCfg(b.template);
    if(cfg && cfg.fields && cfg.fields.length){
      cfg.fields.forEach(f=>{
        const val = (b.fields && (b.fields[f.name] !== undefined)) ? b.fields[f.name] : '';
        if(!val || String(val).trim() === ''){
          addWarning(`–í –±–ª–æ–∫ "${cfg.name || b.template}" ‚Äî –ø–æ–ª–µ "${f.label || f.name}" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ`, b.id);
          warningBlocks.add(b.id);
        }
      });
    }
  });

  // 2) More than 1 header block -> error
  const headers = projectData.blocks.filter(b => b.type === 'header');
  if(headers.length > 1){
    addError(`–í —Å—Ö–µ–º–µ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ —Ç–∏–ø–∞ header (${headers.length})`);
    headers.forEach(h=> {
      errorBlocks.add(h.id);
      addError(`–î—É–±–ª–∏—Ä—É—é—â–∏–π –±–ª–æ–∫ header`, h.id);
    });
  }

  // 3) Connector having more than 1 connection (either incoming or outgoing) -> error
  const connCountMap = {}; // key -> count, key = blockId + ':' + connector
  projectData.connections.forEach(c=>{
    const kFrom = `${c.from}:${c.fromConnector}`;
    const kTo = `${c.to}:${c.toConnector}`;
    connCountMap[kFrom] = (connCountMap[kFrom]||0) + 1;
    connCountMap[kTo] = (connCountMap[kTo]||0) + 1;
  });
  for(const key in connCountMap){
    if(connCountMap[key] > 1){
      // parse key
      const [bid, conn] = key.split(':');
      const blk = projectData.blocks.find(bb => bb.id === bid);
      const blkName = (blk && findCfg(blk.template) && findCfg(blk.template).name) ? findCfg(blk.template).name : (blk ? blk.id : bid);
      addError(`–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä "${conn}" —É –±–ª–æ–∫–∞ "${blkName}" –∏–º–µ–µ—Ç ${connCountMap[key]} —Å–≤—è–∑–µ–π`, bid);
      if(blk) errorBlocks.add(blk.id);
    }
  }

  // 4) Blocks with no incoming connections -> warning (except header blocks which may be start)
  projectData.blocks.forEach(b=>{
    const hasIncoming = projectData.connections.some(c => c.to === b.id);
    if(!hasIncoming && b.type !== 'header'){
      const cfg = findCfg(b.template);
      const displayName = (cfg && cfg.name) ? cfg.name : b.id;
      addWarning(`–í –±–ª–æ–∫ "${displayName}" –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∏ –æ–¥–Ω–∞ —Å–≤—è–∑—å`, b.id);
      warningBlocks.add(b.id);
    }
  });

  // If panel is empty, show a small "–≤—Å–µ —Ö–æ—Ä–æ—à–æ"
  if(panel.children.length === 0){
    const ok = document.createElement('div');
    ok.className = 'small';
    ok.style.opacity = '0.7';
    ok.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Äî –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ—Ç.';
    panel.appendChild(ok);
  }

  // apply highlights (errors override warnings)
  warningBlocks.forEach(id=>{
    if(!errorBlocks.has(id)){
      const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
      if(el) {
        el.classList.add('block-warning');
        const ind = el.querySelector('.block-indicator');
        if(ind){ ind.style.display='flex'; ind.classList.add('indicator-warning'); ind.textContent='!'; }
      }
    }
  });
  errorBlocks.forEach(id=>{
    const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
    if(el){
      el.classList.remove('block-warning');
      el.classList.add('block-error');
      const ind = el.querySelector('.block-indicator');
      if(ind){ ind.style.display='flex'; ind.classList.add('indicator-error'); ind.textContent='‚úï'; }
    }
  });
}

/* ========== Camera movement to block ========== */
function moveCameraToBlock(blockId) {
  const blockEl = mainCanvas.querySelector(`.block[data-block-id="${blockId}"]`);
  if (!blockEl) return;
  
  const blockData = projectData.blocks.find(b => b.id === blockId);
  if (!blockData) return;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã viewport
  const viewport = document.getElementById('viewport');
  const viewportRect = viewport.getBoundingClientRect();
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä viewport
  const viewportCenterX = viewportRect.width / 2;
  const viewportCenterY = viewportRect.height / 2;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –±–ª–æ–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
  const blockX = blockData.x;
  const blockY = blockData.y;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–º–µ—Ä—ã –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
  const newCameraX = viewportCenterX - blockX;
  const newCameraY = viewportCenterY - blockY;
  
  // –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞–º–µ—Ä—É
  camera.x = newCameraX;
  camera.y = newCameraY;
  updateCamera();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç - –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –±–ª–æ–∫
  blockEl.style.transform = 'scale(1.1)';
  blockEl.style.transition = 'transform 0.3s ease';
  
  setTimeout(() => {
    blockEl.style.transform = 'scale(1)';
    setTimeout(() => {
      blockEl.style.transition = '';
    }, 300);
  }, 1000);
}

/* ========== Small helpers ========== */
function updateCounts(){
  document.getElementById('blocksCount').textContent = projectData.blocks.length;
  document.getElementById('connsCount').textContent = projectData.connections.length;
  updateIssues();
}



/* ========== Custom dialogs ========== */
function showCustomPrompt(title, message, callback, defaultValue = '') {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="margin-bottom: 12px; color: var(--muted);">${message}</div>
        <input type="text" class="custom-input" id="customPromptInput" value="${defaultValue}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="handleCustomPrompt(true)">–û–ö</button>
        <button class="btn-ghost" onclick="handleCustomPrompt(false)">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // –§–æ–∫—É—Å –Ω–∞ input
  setTimeout(() => {
    const input = document.getElementById('customPromptInput');
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –∏ Escape
  const handleKeydown = (e) => {
    if (e.key === 'Enter') {
      handleCustomPrompt(true);
    } else if (e.key === 'Escape') {
      handleCustomPrompt(false);
    }
  };
  
  document.addEventListener('keydown', handleKeydown);
  
  window.handleCustomPrompt = (confirmed) => {
    const input = document.getElementById('customPromptInput');
    const value = input ? input.value.trim() : '';
    
    document.body.removeChild(modal);
    document.removeEventListener('keydown', handleKeydown);
    delete window.handleCustomPrompt;
    
    if (confirmed && value) {
      callback(value);
    }
  };
}

function showCustomConfirm(title, message, callback) {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="color: var(--white);">${message}</div>
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="handleCustomConfirm(true)">–î–∞</button>
        <button class="btn-ghost" onclick="handleCustomConfirm(false)">–ù–µ—Ç</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  window.handleCustomConfirm = (confirmed) => {
    document.body.removeChild(modal);
    delete window.handleCustomConfirm;
    
    if (confirmed) {
      callback();
    }
  };
}

function showCustomAlert(title, message) {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="color: var(--white);">${message}</div>
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="closeCustomAlert()">–û–ö</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  window.closeCustomAlert = () => {
    document.body.removeChild(modal);
    delete window.closeCustomAlert;
  };
}

function goToProjectSelection() {
  window.location.href = '/';
}

/* ========== Custom notifications ========== */
function showNotification(type, title, message, duration = 4000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <button class="notification-close" onclick="closeNotification(this)">√ó</button>
    <div class="notification-header">
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
      <span class="notification-title">${title}</span>
    </div>
    <div class="notification-message">${message}</div>
  `;
  
  document.body.appendChild(notification);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
  setTimeout(() => {
    closeNotification(notification.querySelector('.notification-close'));
  }, duration);
}

function closeNotification(closeButton) {
  const notification = closeButton.closest('.notification');
  notification.classList.remove('show');
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 300);
}


/* ========== Theme management ========== */
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('turtcd-theme', theme);
  
  // Update theme selector buttons
  document.querySelectorAll('.theme-option').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[onclick="setTheme('${theme}')"]`).classList.add('active');
}

function loadTheme() {
  const savedTheme = localStorage.getItem('turtcd-theme') || 'dark';
  setTheme(savedTheme);
}

/* ========== Clear workspace ========== */
function clearWorkspace() {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–ª–æ–∫–∏ —Å —Ä–∞–±–æ—á–µ–≥–æ –ø–æ–ª—è?')) {
    // Clear canvas
    mainCanvas.querySelectorAll('.block').forEach(n => n.remove());
    
    // Reset project data
    projectData = { blocks: [], connections: [] };
    
    // Update counts and connections
    updateConnections();
    updateCounts();
  }
}

/* ========== Load current project ========== */
async function loadCurrentProject() {
  const currentProject = localStorage.getItem('currentProject');
  if (currentProject) {
    try {
      const resp = await fetch('/api/project/load-file', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ filename: currentProject })
      });
      const j = await resp.json();
      if(j.status === 'success' && j.project_data){
        loadProjectFromObject(j.project_data);
      }
    } catch(err){ 
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', err); 
    }
  }
}

/* ========== Help Tour System ========== */
let helpTour = {
  isActive: false,
  currentStep: 0,
  steps: [],
  overlay: null,
  spotlight: null,
  tooltip: null
};

// –®–∞–≥–∏ —ç–∫—Å–∫—É—Ä—Å–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –±–ª–æ–∫–æ–≤
const editorSteps = [
  {
    target: '.left h2',
    title: '–ü–∞–ª–∏—Ç—Ä–∞ –±–ª–æ–∫–æ–≤',
    content: '–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º. –ë–ª–æ–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞.',
    position: 'right'
  },
  {
    target: '.left .btn',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º',
    content: '–ö–Ω–æ–ø–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞. –≠–∫—Å–ø–æ—Ä—Ç —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª .turtcd, –∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.',
    position: 'right'
  },
  {
    target: '.left .btn-ghost',
    title: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏',
    content: '–ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ" —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –±–ª–æ–∫–∏ —Å —Ä–∞–±–æ—á–µ–≥–æ –ø–æ–ª—è. –ö–Ω–æ–ø–∫–∞ "–ò–º–ø–æ—Ä—Ç" –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ñ–∞–π–ª–∞.',
    position: 'right'
  },
  {
    target: '.center .toolbar .btn',
    title: '–ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞',
    content: '–ö–Ω–æ–ø–∫–∞ "–°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å" –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤–∞—à–∏ –±–ª–æ–∫–∏ –≤ Python –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å.',
    position: 'bottom'
  },
  {
    target: '.center .toolbar .btn-ghost',
    title: '–ù–∞–≤–∏–≥–∞—Ü–∏—è',
    content: '–ö–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ö–Ω–æ–ø–∫–∞ "–ü–æ–º–æ—â—å" –∑–∞–ø—É—Å–∫–∞–µ—Ç —ç—Ç–æ—Ç —ç–∫—Å–∫—É—Ä—Å.',
    position: 'bottom'
  },
  {
    target: '#mainCanvas',
    title: '–†–∞–±–æ—á–µ–µ –ø–æ–ª–µ',
    content: '–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –±–ª–æ–∫–∏ —Å—é–¥–∞ –∏ —Å–æ–µ–¥–∏–Ω—è–π—Ç–µ –∏—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.',
    position: 'top'
  },
  {
    target: '.right-panel .panel-title',
    title: '–ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
    content: '–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –∏ —Å–≤—è–∑–µ–π. –¢–∞–∫–∂–µ –∑–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏.',
    position: 'left'
  }
];

function startHelpTour() {
  if (helpTour.isActive) {
    return;
  }

  helpTour.isActive = true;
  helpTour.currentStep = 0;
  helpTour.steps = editorSteps;

  createHelpOverlay();
  showHelpStep(0);
}

function createHelpOverlay() {
  // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  helpTour.overlay = document.createElement('div');
  helpTour.overlay.className = 'help-tour-overlay';
  document.body.appendChild(helpTour.overlay);

  // –°–æ–∑–¥–∞–µ–º spotlight
  helpTour.spotlight = document.createElement('div');
  helpTour.spotlight.className = 'help-tour-spotlight';
  helpTour.overlay.appendChild(helpTour.spotlight);

  // –°–æ–∑–¥–∞–µ–º tooltip
  helpTour.tooltip = document.createElement('div');
  helpTour.tooltip.className = 'help-tour-tooltip';
  helpTour.overlay.appendChild(helpTour.tooltip);
}

function showHelpStep(stepIndex) {
  if (stepIndex >= helpTour.steps.length) {
    endHelpTour();
    return;
  }

  // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  document.querySelectorAll('.help-tour-highlighted').forEach(el => {
    el.classList.remove('help-tour-highlighted');
  });

  const step = helpTour.steps[stepIndex];
  const targetElement = document.querySelector(step.target);

  if (!targetElement) {
    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —à–∞–≥
    showHelpStep(stepIndex + 1);
    return;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
  targetElement.classList.add('help-tour-highlighted');

  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º spotlight
  const rect = targetElement.getBoundingClientRect();
  helpTour.spotlight.style.left = (rect.left - 8) + 'px';
  helpTour.spotlight.style.top = (rect.top - 8) + 'px';
  helpTour.spotlight.style.width = (rect.width + 16) + 'px';
  helpTour.spotlight.style.height = (rect.height + 16) + 'px';

  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º tooltip
  positionTooltip(step, rect);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ tooltip
  helpTour.tooltip.innerHTML = `
    <h3>${step.title}</h3>
    <p>${step.content}</p>
    <div class="help-actions">
      ${stepIndex > 0 ? '<button class="btn-ghost" onclick="previousHelpStep()">‚Üê –ù–∞–∑–∞–¥</button>' : ''}
      <button class="btn-ghost" onclick="endHelpTour()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button class="btn" onclick="nextHelpStep()">${stepIndex === helpTour.steps.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–î–∞–ª–µ–µ ‚Üí'}</button>
    </div>
    <div class="help-tour-progress">${stepIndex + 1} –∏–∑ ${helpTour.steps.length}</div>
  `;

  helpTour.currentStep = stepIndex;
}

function positionTooltip(step, targetRect) {
  const tooltip = helpTour.tooltip;
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  const tooltipWidth = 350;
  const tooltipHeight = 200;
  const margin = 20;

  let left, top;

  switch (step.position) {
    case 'top':
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.top - tooltipHeight - margin;
      break;
    case 'bottom':
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.bottom + margin;
      break;
    case 'left':
      left = targetRect.left - tooltipWidth - margin;
      top = targetRect.top + (targetRect.height / 2) - (tooltipHeight / 2);
      break;
    case 'right':
      left = targetRect.right + margin;
      top = targetRect.top + (targetRect.height / 2) - (tooltipHeight / 2);
      break;
    default:
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.bottom + margin;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã viewport
  if (left < margin) left = margin;
  if (left + tooltipWidth > viewportWidth - margin) left = viewportWidth - tooltipWidth - margin;
  if (top < margin) top = targetRect.bottom + margin;
  if (top + tooltipHeight > viewportHeight - margin) top = targetRect.top - tooltipHeight - margin;

  tooltip.style.left = Math.max(0, left) + 'px';
  tooltip.style.top = Math.max(0, top) + 'px';
}

function nextHelpStep() {
  showHelpStep(helpTour.currentStep + 1);
}

function previousHelpStep() {
  if (helpTour.currentStep > 0) {
    showHelpStep(helpTour.currentStep - 1);
  }
}

function endHelpTour() {
  // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  document.querySelectorAll('.help-tour-highlighted').forEach(el => {
    el.classList.remove('help-tour-highlighted');
  });

  if (helpTour.overlay) {
    helpTour.overlay.remove();
  }
  helpTour.isActive = false;
  helpTour.currentStep = 0;
  helpTour.overlay = null;
  helpTour.spotlight = null;
  helpTour.tooltip = null;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —ç–∫—Å–∫—É—Ä—Å—É
document.addEventListener('keydown', function(e) {
  if (!helpTour.isActive) return;

  switch (e.key) {
    case 'Escape':
      endHelpTour();
      break;
    case 'ArrowRight':
    case ' ':
      e.preventDefault();
      nextHelpStep();
      break;
    case 'ArrowLeft':
      e.preventDefault();
      previousHelpStep();
      break;
  }
});

/* ========== Init ========== */
(async function init(){
  await loadBlocksConfig();
  loadTheme();
  await loadCurrentProject();
  // apply camera transform
  updateCamera();
  updateCounts();
})();
</script>
</body>
</html>