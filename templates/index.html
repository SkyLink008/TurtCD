<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TurtCD ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --accent:#06b6d4;
    --accent-2:#8b5cf6;
    --card:#0b1226;
    --muted:#94a3b8;
    --white:#ffffff;
    --success:#10b981;
    --danger:#ef4444;
    --panel-width:300px;
  }
  
  /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
  [data-theme="light"] {
    --bg:#f8fafc;
    --panel:#ffffff;
    --accent:#0ea5e9;
    --accent-2:#6366f1;
    --card:#ffffff;
    --muted:#64748b;
    --white:#1e293b;
    --success:#059669;
    --danger:#dc2626;
  }
  
  [data-theme="light"] body {
    background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    color: var(--white);
  }
  
  [data-theme="light"] .left,
  [data-theme="light"] .right-panel {
    background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] .center {
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    background: linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
  }
  
  [data-theme="light"] .toolbar {
    border-bottom: 1px solid rgba(0,0,0,0.1);
    background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
  }
  
  [data-theme="light"] .block {
    background: var(--card);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  }
  
  [data-theme="light"] .block:hover {
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  
  [data-theme="light"] .block-header {
    background: linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.02));
    color: var(--white);
  }
  
  [data-theme="light"] .block-content {
    background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00));
  }
  
  [data-theme="light"] .field-input {
    background: rgba(0,0,0,0.05);
    color: var(--white);
    border: 1px solid rgba(0,0,0,0.1);
    resize: vertical;
    min-height: 32px;
    max-height: 200px;
    font-family: inherit;
    line-height: 1.4;
    overflow-y: auto;
  }
  
  
  [data-theme="light"] .category-header {
    background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent);
  }
  
  [data-theme="light"] .category-header:hover {
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  }
  
  [data-theme="light"] .block-item {
    background: linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] .block-item:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }
  
  /* Force white text on canvas blocks in light theme for readability */
  [data-theme="light"] .block,
  [data-theme="light"] .block-header,
  [data-theme="light"] .block-content,
  [data-theme="light"] .block .small,
  [data-theme="light"] .block .block-name {
    color: #ffffff !important;
  }
  [data-theme="light"] .field-input {
    color: #ffffff !important;
  }
  
  /* Force white text in context menu (right-click) under light theme */
  [data-theme="light"] #blockContextMenu .menu-item {
    color: #ffffff !important;
  }
  
  /* Connection lines for light theme */
  [data-theme="light"] .connection-line { 
    background: linear-gradient(90deg, #0ea5e9, #6366f1) !important; 
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#071025 0%,#0b1220 100%); color:var(--white); -webkit-font-smoothing:antialiased}
  .app { display:flex; height:100vh; gap:16px; padding:16px; }
  .left {
    width:var(--panel-width);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; box-shadow:0 8px 30px rgba(2,6,23,0.6); overflow:auto;
  }
  .left h2 { margin:0 0 12px; font-size:18px; letter-spacing:0.2px; color:var(--white); }
  .category-header { display:flex; justify-content:space-between; align-items:center; padding:8px; cursor:pointer; border-radius:8px; margin-top:8px; transition:all .18s; background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent); }
  .category-header:hover { transform:translateY(-3px); box-shadow:0 6px 18px rgba(2,6,23,0.45); }
  .category-title { font-weight:600; color:#e6eef6; }
  [data-theme="light"] .category-title { font-weight:600; color:#1e293b; }
  .collapse-indicator { opacity:0.7; font-size:12px; }
  .block-list { display:grid; gap:8px; margin-top:8px; padding-bottom:12px; }
  .block-item { display:flex; gap:8px; align-items:center; padding:10px; border-radius:10px; cursor:grab; user-select:none;
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03);
    transition:transform .12s, box-shadow .12s; }
  .block-item:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.55); }
  .color-dot { width:14px; height:14px; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.12); }
  .block-name { font-size:13px; color:#e6eef6; font-weight:600; }
  [data-theme="light"] .block-name { font-size:13px; color:#1e293b; font-weight:600; }

  .center {
    flex:1; position:relative; overflow:hidden; border-radius:12px; box-shadow:0 10px 40px rgba(2,6,23,0.6);
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));
    display:flex; flex-direction:column;
  }
  .toolbar { display:flex; gap:10px; padding:12px; align-items:center; border-bottom:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); }
  .btn { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#022; padding:8px 12px; border-radius:10px; border:none; font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(14,165,233,0.08); transition:transform .12s; }
  .btn:hover { transform:translateY(-3px); }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--white); padding:8px 10px; border-radius:10px; cursor:pointer; }
  
  /* –°–µ–ª–µ–∫—Ç–æ—Ä —Ç–µ–º */
  .theme-selector {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 6px;
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .theme-selector:hover {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.25);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }
  
  #themeDropdown {
    background: transparent;
    border: none;
    color: var(--white);
    font-size: 13px;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    outline: none;
    min-width: 140px;
    transition: all 0.2s ease;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px;
    padding-right: 32px;
  }
  
  #themeDropdown:hover {
    background-color: rgba(255,255,255,0.1);
  }
  
  #themeDropdown:focus {
    background-color: rgba(255,255,255,0.15);
    box-shadow: 0 0 0 2px rgba(6,182,212,0.3);
  }
  
  #themeDropdown option {
    background: #1a1a1a;
    color: #ffffff;
    padding: 10px 12px;
    font-size: 13px;
    font-weight: 500;
  }
  
  [data-theme="light"] .theme-selector {
    background: rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.15);
  }
  
  [data-theme="light"] .theme-selector:hover {
    background: rgba(0,0,0,0.12);
    border-color: rgba(0,0,0,0.25);
  }
  
  [data-theme="light"] #themeDropdown {
    color: var(--white);
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  }
  
  [data-theme="light"] #themeDropdown:hover {
    background-color: rgba(0,0,0,0.1);
  }
  
  [data-theme="light"] #themeDropdown option {
    background: #ffffff;
    color: #1e293b;
  }
  
  [data-theme="halloween"] .theme-selector {
    background: rgba(255,140,0,0.1);
    border: 1px solid rgba(255,140,0,0.3);
  }
  
  [data-theme="halloween"] .theme-selector:hover {
    background: rgba(255,140,0,0.15);
    border-color: rgba(255,140,0,0.5);
  }
  
  [data-theme="halloween"] #themeDropdown {
    color: var(--white);
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF8C00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  }
  
  [data-theme="halloween"] #themeDropdown:hover {
    background-color: rgba(255,140,0,0.2);
  }
  
  [data-theme="halloween"] #themeDropdown option {
    background: #2d1b0f;
    color: #ffffff;
  }

  .workspace { position:relative; flex:1; overflow:hidden; display:flex; }
  #viewport { position:relative; flex:1; overflow:hidden; }
  #mainCanvas { position:absolute; left:0; top:0; width:16000px; height:16000px; transform:translate(0px,0px) scale(1); transition:transform .08s linear; }
  .block { position:absolute; min-width:140px; border-radius:12px; color:var(--white); background:var(--card); box-shadow: 0 12px 30px rgba(2,6,23,0.6); overflow:visible; transform-origin:left top; transition:box-shadow .12s, transform .08s; }
  .block:hover { box-shadow:0 20px 60px rgba(2,6,23,0.75); transform:translateY(-4px); }
  .block-warning { outline: 2px solid #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25), 0 14px 36px rgba(245, 158, 11, 0.25) !important; }
  .block-error { outline: 2px solid #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.30), 0 14px 36px rgba(239, 68, 68, 0.30) !important; }
  .block-indicator { position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%; display:none; align-items:center; justify-content:center; font-weight:800; font-size:13px; color:#0b1220; z-index:70; box-shadow:0 6px 14px rgba(0,0,0,0.25); }
  .indicator-warning { background:#f59e0b; color:#1f2937; }
  .indicator-error { background:#ef4444; color:#fff; }
  .block-header { padding:12px; font-weight:800; letter-spacing:0.2px; font-size:14px; background:linear-gradient(90deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02)); cursor:move; -webkit-user-select:none; -moz-user-select:none; user-select:none; color: var(--white); }
  .block-content { padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); min-height:36px; display:flex; flex-direction:column; gap:8px; }
  .field-input { 
    padding:8px; 
    border-radius:8px; 
    border:1px solid rgba(0,0,0,0.15); 
    font-size:13px; 
    background:rgba(255,255,255,0.96); 
    color:#0b1220;
    resize: vertical;
    min-height: 32px;
    max-height: 200px;
    font-family: inherit;
    line-height: 1.4;
    overflow-y: auto;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
  .field-input.single-line {
    resize: none;
    height: 32px;
    min-height: 32px;
    max-height: 32px;
    overflow: hidden;
    white-space: nowrap;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
  .field-input.multi-line {
    resize: vertical;
    min-height: 32px;
    max-height: 200px;
  }
  
  /* –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ */
  .autocomplete-container {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  
  .autocomplete-dropdown {
    position: fixed;
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    z-index: 10000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    min-width: 200px;
    max-width: 300px;
  }
  
  .autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    color: var(--white);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background-color 0.2s;
  }
  
  .autocomplete-item:hover {
    background: var(--accent);
    color: #000;
  }
  
  .autocomplete-item:last-child {
    border-bottom: none;
  }
  
  .autocomplete-item.highlighted {
    background: var(--accent);
    color: #000;
  }
  
  .autocomplete-item .value-text {
    font-weight: 500;
  }
  
  .autocomplete-item .value-count {
    font-size: 11px;
    opacity: 0.7;
    margin-left: 8px;
  }

  /* –†–µ–µ—Å—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö */
  .variables-registry { 
    margin-top: 8px; 
    display: flex; 
    flex-direction: column; 
    gap: 6px; 
    max-height: 300px; 
    overflow-y: auto; 
    padding-right: 4px;
  }
  
  /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —Ä–µ–µ—Å—Ç—Ä–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö */
  .variables-registry::-webkit-scrollbar {
    width: 6px;
  }
  
  .variables-registry::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }
  
  .variables-registry::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }
  
  .variables-registry::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Firefox */
  .variables-registry {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05);
  }
  .var-row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; }
  .var-name { flex: 1; color: var(--white); font-size: 13px; }
  .var-count { color: rgba(255,255,255,0.7); font-size: 12px; }
  .tag-select { background: #000; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 12px; padding: 4px 6px; }
  .tag-select option { background: #000; color: #fff; }
  .tag-icon { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; }
  
  /* –¶–≤–µ—Ç —Å—á—ë—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ —Ç–µ–º–∞–º */
  /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç—ë–º–Ω—ã–µ —Ç–µ–º—ã, hacker, mono) ‚Äî –±–µ–ª—ã–π/–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —É–∂–µ –∑–∞–¥–∞–Ω */
  [data-theme="light"] .var-count,
  [data-theme="nebo"] .var-count { color: #000 !important; }

  /* Error warning modal styles */
  .error-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
  }

  .error-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .error-modal-content {
    position: relative;
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    animation: errorModalSlideIn 0.3s ease-out;
    margin: auto;
  }

  @keyframes errorModalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .error-modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .error-modal-header h3 {
    margin: 0;
    color: #ef4444;
    font-size: 20px;
    font-weight: 700;
  }

  .error-modal-body {
    padding: 20px 24px;
    line-height: 1.6;
    color: var(--white);
  }

  .error-modal-body p {
    margin: 0 0 12px;
  }

  .error-modal-body p:last-child {
    margin-bottom: 0;
  }

  .issues-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .issue-count {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
  }

  .issue-icon {
    font-size: 20px;
  }

  .issue-text {
    color: var(--white);
  }

  .error-count {
    color: #ef4444;
  }

  .warning-count {
    color: #f59e0b;
  }

  .error-modal-footer {
    padding: 16px 24px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .btn-danger {
    background: #ef4444 !important;
    color: white !important;
    border: none !important;
    opacity: 0.5;
    cursor: not-allowed;
    transition: all 0.3s ease;
  }

  .btn-danger:not(:disabled) {
    opacity: 1;
    cursor: pointer;
  }

  .btn-danger:not(:disabled):hover {
    background: #dc2626 !important;
    transform: translateY(-2px);
  }

  /* —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
  .connector, .connection-line, .connection-point { -webkit-user-select:none; -moz-user-select:none; user-select:none; }
  .temp-line { pointer-events:none; }

  .connector { position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; border:2px solid rgba(0,0,0,0.5); z-index:60; }
  .connector-top{ top:-10px; left:50%; transform:translateX(-50%); }
  .connector-bottom{ bottom:-10px; left:50%; transform:translateX(-50%); }
  .connector-right{ top:50%; right:-10px; transform:translateY(-50%); }
  .connector-left{ top:50%; left:-10px; transform:translateY(-50%); }

  .connection-line{ position:absolute; height:4px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transform-origin:0 0; z-index:40; border-radius:6px; box-shadow:0 6px 16px rgba(11,20,40,0.3); }
  .connection-point{ position:absolute; width:12px; height:12px; border-radius:50%; background:var(--success); z-index:45; box-shadow:0 6px 16px rgba(16,185,129,0.12); cursor:context-menu; }

  /* –¶–≤–µ—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π */
  .connection-line.color-system { 
    background: linear-gradient(90deg, var(--accent), var(--accent-2)); 
  }
  .connection-line.color-orange { 
    background: linear-gradient(90deg, #ff8c00, #ffa500); 
  }
  .connection-line.color-red { 
    background: linear-gradient(90deg, #ff4444, #ff6666); 
  }
  .connection-line.color-green { 
    background: linear-gradient(90deg, #00ff88, #44ffaa); 
  }
  .connection-line.color-purple { 
    background: linear-gradient(90deg, #8b5cf6, #a78bfa); 
  }


  /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π */
  .connection-context-menu {
    position: absolute;
    z-index: 10000;
    background: var(--panel);
    border: 1px solid var(--accent-2);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    color: var(--white);
    padding: 8px 0;
    display: none;
    min-width: 200px;
  }
  
  .connection-context-menu .menu-section {
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .connection-context-menu .menu-section:last-child {
    border-bottom: none;
  }
  
  .connection-context-menu .menu-section-title {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .connection-context-menu .menu-item {
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    color: var(--white);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
  }
  
  .connection-context-menu .menu-item:hover {
    background: var(--accent);
    color: #000;
  }
  
  .connection-context-menu .menu-item .color-preview {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .right-panel { width:300px; background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border-radius:12px; padding:12px; box-shadow:0 8px 40px rgba(2,6,23,0.6); display:flex; flex-direction:column; }
  .panel-title { font-weight:800; margin-bottom:10px }
  .small { font-size:13px; color:var(--muted) }
  .mods-section { margin-top:auto; }
  
  /* –í–∫–ª–∞–¥–∫–∏ –ø–∞–Ω–µ–ª–∏ */
  .panel-tabs {
    display: flex;
    margin-bottom: 12px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 4px;
  }
  
  .tab-button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: var(--muted);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .tab-button.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 8px rgba(14,165,233,0.3);
  }
  
  .tab-button:hover:not(.active) {
    background: rgba(255,255,255,0.1);
    color: var(--white);
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  
  
  /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã–µ –æ–∫–Ω–∞ */
  .custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  
  .custom-modal-content {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    min-width: 400px;
    max-width: 600px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .custom-modal-header {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--white);
  }
  
  .custom-modal-body {
    margin-bottom: 20px;
  }
  
  .custom-modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .custom-input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: var(--white);
    font-size: 14px;
    margin-bottom: 12px;
  }
  
  .custom-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6,182,212,0.1);
  }
  
  .custom-input::placeholder {
    color: var(--muted);
  }
  
  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 10001;
    min-width: 300px;
    max-width: 400px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  
  .notification.show {
    transform: translateX(0);
  }
  
  .notification.success {
    border-left: 4px solid var(--success);
  }
  
  .notification.error {
    border-left: 4px solid var(--danger);
  }
  
  .notification-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }
  
  .notification-icon {
    font-size: 20px;
  }
  
  .notification-title {
    font-weight: 600;
    color: var(--white);
    font-size: 16px;
  }
  
  .notification-message {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.4;
  }
  
  .notification-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  
  .notification-close:hover {
    background: rgba(255,255,255,0.1);
    color: var(--white);
  }
  

  /* –º–æ–¥—É–ª—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π/–æ—à–∏–±–æ–∫ */
  .issues-container { margin-top:12px; max-height:320px; overflow:auto; padding-right:6px; }
  .issue {
    display:flex; gap:8px; align-items:flex-start; padding:10px; border-radius:8px; margin-bottom:8px;
    font-size:13px; line-height:1.2;
  }
  .issue .icon {
    min-width:20px; min-height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800;
    flex-shrink:0;
  }
  .issue.warning { background: rgba(74, 63, 12, 0.12); color: #5a4e07; transition: all 0.2s ease; }
  .issue.warning:hover { background: rgba(74, 63, 12, 0.2); transform: translateY(-1px); }
  .issue.warning .icon { background: #4f3700; color: #ffd54a; width:26px; height:26px; border-radius:4px; display:flex; align-items:center; justify-content:center; }
  .issue.error { background: rgba(139, 0, 0, 0.08); color: #7a1515; transition: all 0.2s ease; }
  .issue.error:hover { background: rgba(139, 0, 0, 0.15); transform: translateY(-1px); }
  .issue.error .icon { background: #7a1515; color: #ffccd5; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

  /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Å–∫—É—Ä—Å–∞ */
  .help-tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 99999;
    pointer-events: none;
  }

  .help-tour-spotlight {
    position: absolute;
    border: 3px solid var(--accent);
    border-radius: 12px;
    background: transparent;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 30px rgba(6, 182, 212, 0.8);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 99999;
  }

  .help-tour-tooltip {
    position: absolute;
    background: var(--card);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 350px;
    z-index: 99999;
    pointer-events: auto;
    animation: helpTooltipAppear 0.3s ease;
  }

  @keyframes helpTooltipAppear {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .help-tour-tooltip h3 {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--white);
  }

  .help-tour-tooltip p {
    margin: 0 0 16px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--muted);
  }

  .help-tour-tooltip .help-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .help-tour-tooltip .btn {
    padding: 8px 16px;
    font-size: 13px;
  }

  .help-tour-tooltip .btn-ghost {
    padding: 8px 16px;
    font-size: 13px;
  }

  .help-tour-progress {
    position: absolute;
    bottom: 12px;
    left: 20px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }

  /* –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .help-tour-highlighted {
    position: relative;
    z-index: 99999 !important;
    transform: scale(1.02);
    transition: all 0.3s ease;
    filter: brightness(1.1) contrast(1.1);
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
  }

  @media (max-width:1100px){ .left{display:none} .right-panel{display:none} }

/* ===== –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ===== */

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚Äî –æ–±—â–∏–π —Å—Ç–∏–ª—å */
.context-menu {
  position: absolute;
  z-index: 9999;
  background: var(--panel);
  border: 1px solid var(--accent-2);
  border-radius: 6px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  color: #ffffff;
  padding: 4px 0;
  display: none;
}
.context-menu-item {
  padding: 6px 12px;
  cursor: pointer;
  user-select: none;
  color: #ffffff;
}
.context-menu-item:hover {
  background: var(--accent);
  color: #000;
}

/* –•–∞–∫–µ—Ä */
[data-theme="hacker"] {
  --bg: #000000;
  --panel: #000000;
  --accent: #7CFC00;
  --accent-2: #3a7f00;
  --card: #000000;
  --muted: #9ae89a;
  --white: #e6ffe6;
}
[data-theme="hacker"] body { background: #000; color: var(--white); }
[data-theme="hacker"] .block,
[data-theme="hacker"] .block-header,
[data-theme="hacker"] .block-content,
[data-theme="hacker"] .block-item {
  background: #000 !important;
  color: #7CFC00 !important;
  border: 1px solid #7CFC00 !important;
}
[data-theme="hacker"] .color-dot { background: #7CFC00 !important; }
[data-theme="hacker"] .connection-line { background: linear-gradient(90deg, #7CFC00, #3a7f00) !important; }
[data-theme="hacker"] .theme-option.active { background: #7CFC00; color: #000; }
[data-theme="hacker"] .context-menu { background: #000; color: #ffffff; border-color: #3a7f00; }
[data-theme="hacker"] .context-menu-item { color: #ffffff; }
[data-theme="hacker"] .context-menu-item:hover { background: #7CFC00; color: #000; }

/* –ù–µ–±–æ */
[data-theme="nebo"] {
  --bg: #f8ffff;
  --panel: #ffffff;
  --accent: #40E0D0;
  --accent-2: #a7f1ec;
  --card: #ffffff;
  --muted: #6b94a1;
  --white: #003333;
}
[data-theme="nebo"] body {
  background: linear-gradient(180deg, #f9feff 0%, #eefcff 100%);
  color: var(--white);
}
[data-theme="nebo"] .block,
[data-theme="nebo"] .block-header,
[data-theme="nebo"] .block-content,
[data-theme="nebo"] .block-item {
  background: #ffffff !important;
  color: #003333 !important;
  border-color: rgba(64,224,208,0.15) !important;
}
[data-theme="nebo"] .block-group-title,
[data-theme="nebo"] .block-category-title,
[data-theme="nebo"] .block-name {
  color: #000000 !important;
}
[data-theme="nebo"] .category-title {
  color: #000000 !important;
}
[data-theme="nebo"] .color-dot { background: #40E0D0 !important; }
[data-theme="nebo"] .connection-line { background: linear-gradient(90deg, #40E0D0, #a7f1ec) !important; }
[data-theme="nebo"] .theme-option.active { background: #40E0D0; color: #003; }
[data-theme="nebo"] .context-menu { background: #fff; color: #ffffff; border-color: #40E0D0; }
[data-theme="nebo"] .context-menu-item { color: #ffffff; }
[data-theme="nebo"] .context-menu-item:hover { background: #40E0D0; color: #000; }

/* –ú–æ–Ω–æ */
[data-theme="mono"] {
  --bg: #0f0f0f;
  --panel: #111111;
  --accent: #ffffff;
  --accent-2: #bfbfbf;
  --card: #0b0b0b;
  --muted: #9a9a9a;
  --white: #ffffff;
}
[data-theme="mono"] body { background: #0b0b0b; color: var(--white); }
[data-theme="mono"] .block,
[data-theme="mono"] .block-header,
[data-theme="mono"] .block-content,
[data-theme="mono"] .block-item {
  background: #111 !important;
  color: #fff !important;
  border: 1px solid #ffffff !important;
}
[data-theme="mono"] .color-dot { background: #fff !important; }
[data-theme="mono"] .connection-line { background: linear-gradient(90deg, #ffffff, #bfbfbf) !important; }
[data-theme="mono"] .theme-option.active { background: #fff; color: #000; }
[data-theme="mono"] .context-menu { background: #111; color: #ffffff; border-color: #bfbfbf; }
[data-theme="mono"] .context-menu-item { color: #ffffff; }
[data-theme="mono"] .context-menu-item:hover { background: #fff; color: #000; }

/* –•—ç–ª–ª–æ—É–∏–Ω */
[data-theme="halloween"] {
  --bg: #1a0f0a;
  --panel: #2d1b0f;
  --accent: #FF8C00;
  --accent-2: #ff6b00;
  --card: #1a0f0a;
  --muted: #cc8c66;
  --white: #ffffff;
}
[data-theme="halloween"] body { background: #1a0f0a; color: var(--white); }
[data-theme="halloween"] .block,
[data-theme="halloween"] .block-header,
[data-theme="halloween"] .block-content,
[data-theme="halloween"] .block-item {
  background: #2d1b0f !important;
  color: #fff !important;
  border: 1px solid #FF8C00 !important;
}
[data-theme="halloween"] .color-dot { background: #FF8C00 !important; }
[data-theme="halloween"] .connection-line { background: linear-gradient(90deg, #FF8C00, #ff6b00) !important; }
[data-theme="halloween"] .context-menu { background: #2d1b0f; color: #ffffff; border-color: #FF8C00; }
[data-theme="halloween"] .context-menu-item { color: #ffffff; }
[data-theme="halloween"] .context-menu-item:hover { background: #FF8C00; color: #000; }

/* –†–æ–∑–æ–≤–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è */
[data-theme="pinkviolet"] {
  --bg: #2a133d;
  --panel: #3b2562;
  --accent: #ff91e9;
  --accent-2: #ad5fff;
  --card: #41275a;
  --muted: #c97ad9;
  --white: #fff1fa;
}
[data-theme="pinkviolet"] body { background: linear-gradient(180deg, #2a133d 0%, #41275a 100%); color: var(--white); }
[data-theme="pinkviolet"] .block,
[data-theme="pinkviolet"] .block-header,
[data-theme="pinkviolet"] .block-content,
[data-theme="pinkviolet"] .block-item {
  background: #3b2562 !important;
  color: #fff1fa !important;
  border: 1px solid #ad5fff !important;
}
[data-theme="pinkviolet"] .color-dot { background: #ff91e9 !important; }
[data-theme="pinkviolet"] .connection-line { background: linear-gradient(90deg, #ff91e9, #ad5fff) !important; }
[data-theme="pinkviolet"] .theme-option.active { background: #ff91e9; color: #2a133d; }
[data-theme="pinkviolet"] .context-menu { background: #3b2562; color: #fff1fa; border-color: #ad5fff; }
[data-theme="pinkviolet"] .context-menu-item { color: #fff1fa; }
[data-theme="pinkviolet"] .context-menu-item:hover { background: #ff91e9; color: #2a133d; }

/* –ö—Ä–∞—Å–Ω–∞—è */
[data-theme="red"] {
  --bg: #0f0f0f;
  --panel: #111111;
  --accent: #ff2121;
  --accent-2: #ee5959;
  --card: #0b0b0b;
  --muted: #ee5959;
  --white: #ff2121;
}
[data-theme="red"] body { background: #0b0b0b; color: var(--white); }
[data-theme="red"] .block,
[data-theme="red"] .block-header,
[data-theme="red"] .block-content,
[data-theme="red"] .block-item {
  background: #111 !important;
  color: #ff2121 !important;
  border: 1px solid #ff2121 !important;
}
[data-theme="red"] .color-dot { background: #ff2121 !important; }
[data-theme="red"] .connection-line { background: linear-gradient(90deg, #ff2121, #ee5959) !important; }
[data-theme="red"] .theme-option.active { background: #ff2121; color: #111; }
[data-theme="red"] .context-menu { background: #111; color: #ff2121; border-color: #ff2121; }
[data-theme="red"] .context-menu-item { color: #ff2121; }
[data-theme="red"] .context-menu-item:hover { background: #ff2121; color: #000; }


/* ==== –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–º—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ==== */

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚Äî –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–µ–º */
.context-menu {
  position: absolute;
  z-index: 9999;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  color: #ffffff;
  padding: 4px 0;
  display: none;
}
.context-menu-item {
  padding: 6px 12px;
  cursor: pointer;
  user-select: none;
  color: #ffffff;
}
.context-menu-item:hover {
  background: #f0f0f0;
  color: #000;
}

/* –ó–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
.block,
.block-header,
.block-content,
.block-item {
  border-radius: 10px !important;
}

/* –•–∞–∫–µ—Ä */
[data-theme="hacker"] .block,
[data-theme="hacker"] .block-header,
[data-theme="hacker"] .block-content,
[data-theme="hacker"] .block-item {
  border-radius: 10px !important;
  border: 1px solid #7CFC00 !important;
}

/* –ù–µ–±–æ */
[data-theme="nebo"] .block,
[data-theme="nebo"] .block-header,
[data-theme="nebo"] .block-content,
[data-theme="nebo"] .block-item {
  border-radius: 10px !important;
}
[data-theme="nebo"] .block-group-title,
[data-theme="nebo"] .block-category-title,
[data-theme="nebo"] .block-name {
  color: #000000 !important;
}
[data-theme="nebo"] .category-title {
  color: #000000 !important;
}

/* –ú–æ–Ω–æ */
[data-theme="mono"] .block,
[data-theme="mono"] .block-header,
[data-theme="mono"] .block-content,
[data-theme="mono"] .block-item {
  border-radius: 10px !important;
  border: 1px solid #ffffff !important;
}

/* ===== Themed basic modal (shared) ===== */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(2px); display:flex; align-items:center; justify-content:center; z-index:10050; }
.modal { background: var(--card); color: var(--white); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 60px rgba(2,6,23,0.6); padding: 20px; width: min(560px, 92vw); }
[data-theme="light"] .modal { border: 1px solid rgba(0,0,0,0.08); }
.modal h3 { margin: 0 0 10px 0; font-size: 18px; font-weight: 800; }
.modal .input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: var(--white); outline: none; }
[data-theme="light"] .modal .input { border: 1px solid rgba(0,0,0,0.12); color: var(--white); }

body {
    font-family: monospace !important;
    font-size: 18px !important;
}
button, .button, input[type=button], input[type=submit] {
    font-family: monospace !important;
    font-size: 16px !important;
}
</style>
</head>
<body>
  <div class="app">

    <!-- Left palette -->
    <div class="left">
      <h2>–ü–∞–ª–∏—Ç—Ä–∞ –±–ª–æ–∫–æ–≤</h2>
      <div id="categoriesList"></div>

      <div style="height:8px"></div>
      <div style="display:flex; gap:8px;">
        <button class="btn" onclick="openExportModal()">‚¨á –≠–∫—Å–ø–æ—Ä—Ç (.turtcd)</button>
        <button class="btn" onclick="saveProject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      
      <div style="height:8px"></div>
      <button class="btn-ghost" onclick="openClearModal()" style="width:100%; color:var(--danger); border-color:var(--danger);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>

      <div style="height:12px"></div>
      <input id="importFile" type="file" accept=".turtcd,application/json" style="display:none" onchange="importFromFile(event)"/>
      <button class="btn-ghost" onclick="document.getElementById('importFile').click()">‚¨Ü –ò–º–ø–æ—Ä—Ç (.turtcd)</button>

      <div style="height:12px"></div>
      <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∏: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –±–ª–æ–∫–∏ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã –Ω–∞ –ø–æ–ª–µ. Ctrl + –õ–ö–ú ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã. –ü–ö–ú –Ω–∞ –±–ª–æ–∫ ‚Äî –º–µ–Ω—é.</div>
    </div>

    <!-- Center area -->
    <div class="center">
      <div class="toolbar">
        <button class="btn" onclick="compileProject()">‚ñ∂ –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn-ghost" onclick="goToProjectSelection()">üè† –ú–µ–Ω—é</button>
        <button class="btn-ghost" onclick="startHelpTour()">‚ùì –ü–æ–º–æ—â—å</button>
        <div style="flex:1"></div>
        <div class="theme-selector">
          <select id="themeDropdown" onchange="setTheme(this.value)">
            <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
            <option value="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
            <option value="hacker">üñ•Ô∏è –•–∞–∫–µ—Ä</option>
            <option value="nebo">‚òÅÔ∏è –ù–µ–±–æ</option>
            <option value="mono">‚¨õ –ú–æ–Ω–æ</option>
            <option value="halloween">üéÉ –•—ç–ª–ª–æ—É–∏–Ω</option>
            <option value="pinkviolet">üå∏ –†–æ–∑–æ–≤–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
            <option value="red">üî¥ –ö—Ä–∞—Å–Ω–∞—è</option>
          </select>
        </div>
      </div>

      <div class="workspace" id="workspace">
        <div id="viewport" style="flex:1; position:relative; overflow:hidden">
          <div id="mainCanvas"></div>
        </div>
      </div>
    </div>

    <!-- Right info panel -->
    <div class="right-panel">
      <div class="panel-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
      <div><strong>–ë–ª–æ–∫–∏:</strong> <span id="blocksCount">0</span></div>
      <div><strong>–°–≤—è–∑–∏:</strong> <span id="connsCount">0</span></div>
      <div style="height:12px"></div>
      <div class="small">–ò—Å–ø–æ–ª—å–∑—É–π ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, ¬´–≠–∫—Å–ø–æ—Ä—Ç¬ª ‚Äî —Å–∫–∞—á–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ .turtcd</div>

      <div style="height:8px"></div>
      <button id="toggleGlobalIgnoreBtn" class="btn" onclick="toggleGlobalIgnore()">–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏</button>

      <div style="height:8px"></div>
      

      <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ -->
      <div id="issuesPanel" class="issues-container" aria-live="polite"></div>

      <!-- –†–µ–µ—Å—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö -->
      <div style="height:16px"></div>
      <div class="panel-title">–†–µ–µ—Å—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</div>
      <div id="variableRegistry" class="variables-registry"></div>

      <div class="mods-section">
        <div style="height:16px"></div>
        <div class="panel-title">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
        <div id="modsPanel" class="mods-panel small"></div>
      </div>
    </div>
  </div>

  <!-- Context menu for blocks -->
  <div id="blockContextMenu" style="position:absolute; display:none; z-index:20000;">
    <div style="background:#071025; padding:8px; border-radius:8px; box-shadow:0 8px 28px rgba(2,6,23,0.6); min-width:160px;">
      <div id="blockPathInfo" class="menu-item" style="padding:8px; cursor:default; color:rgba(255,255,255,0.8); border-bottom:1px solid rgba(255,255,255,0.08); margin-bottom:4px">
        
      </div>
      <div id="lockMenuItem" class="menu-item" style="padding:8px; cursor:pointer; color:#ffffff;" onclick="toggleLockForContextBlock()">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫</div>
      <div class="menu-item" style="padding:8px; cursor:pointer; color:#ffffff;" onclick="duplicateContextBlock()">üìÑ –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</div>
      <div class="menu-item" style="padding:8px; cursor:pointer; color:#ffffff;" onclick="toggleFieldInputType()">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∏–ø –ø–æ–ª–µ–π</div>
      <div id="ignoreIssueMenuItem" class="menu-item" style="padding:8px; cursor:pointer; color:#ffffff;" onclick="toggleIgnoreIssuesForContextBlock()">üü¢ –í–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞</div>
      <div class="menu-item" style="padding:8px; cursor:pointer; color:#ffffff;" onclick="deleteContextBlock()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
    </div>
  </div>

  <!-- Context menu for connections -->
  <div id="connectionContextMenu" class="connection-context-menu">
    <div class="menu-section">
      <div class="menu-section-title">–¶–≤–µ—Ç</div>
      <div class="menu-item" onclick="changeConnectionColor('system')">
        <div class="color-preview" style="background: linear-gradient(90deg, var(--accent), var(--accent-2));"></div>
        <span>–°–∏—Å—Ç–µ–º–Ω—ã–π —Ü–≤–µ—Ç</span>
      </div>
      <div class="menu-item" onclick="changeConnectionColor('orange')">
        <div class="color-preview" style="background: linear-gradient(90deg, #ff8c00, #ffa500);"></div>
        <span>–û—Ä–∞–Ω–∂–µ–≤—ã–π</span>
      </div>
      <div class="menu-item" onclick="changeConnectionColor('red')">
        <div class="color-preview" style="background: linear-gradient(90deg, #ff4444, #ff6666);"></div>
        <span>–ö—Ä–∞—Å–Ω—ã–π</span>
      </div>
      <div class="menu-item" onclick="changeConnectionColor('green')">
        <div class="color-preview" style="background: linear-gradient(90deg, #00ff88, #44ffaa);"></div>
        <span>–ó–µ–ª–µ–Ω—ã–π</span>
      </div>
      <div class="menu-item" onclick="changeConnectionColor('purple')">
        <div class="color-preview" style="background: linear-gradient(90deg, #8b5cf6, #a78bfa);"></div>
        <span>–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</span>
      </div>
    </div>
    
    <div class="menu-section">
      <div class="menu-item" onclick="deleteConnection()" style="color: var(--danger);">
        <span>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</span>
      </div>
    </div>
  </div>


  <!-- Save modal -->
  <div id="saveModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
        <div style="margin-bottom:8px">–ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):</div>
        <input id="saveFilename" class="input" placeholder="–º–æ–π_–ø—Ä–æ–µ–∫—Ç">
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" onclick="saveToServer()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn-ghost" onclick="closeSaveModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export .turtcd modal -->
  <div id="exportModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ (.turtcd)</h3>
        <div style="margin-bottom:8px">–ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):</div>
        <input id="exportFilename" class="input" placeholder="project">
        <div class="small" style="opacity:0.8; margin-top:6px">–§–∞–π–ª –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.</div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" onclick="confirmExportTurtcd()">–°–∫–∞—á–∞—Ç—å</button>
          <button class="btn-ghost" onclick="closeExportModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Unsaved changes modal -->
  <div id="unsavedChangesModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h3>
        <div class="small" style="opacity:0.9; margin-bottom:12px">
          –í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º –≤ –º–µ–Ω—é?
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" onclick="confirmUnsavedSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn-ghost" onclick="confirmUnsavedDiscard()">–ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å</button>
          <button class="btn-ghost" onclick="closeUnsavedChangesModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clear workspace modal -->
  <div id="clearModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–û—á–∏—Å—Ç–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –ø–æ–ª–µ</h3>
        <div style="margin-bottom:8px">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–ª–æ–∫–∏ —Å —Ä–∞–±–æ—á–µ–≥–æ –ø–æ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" onclick="confirmClearWorkspace()">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn-ghost" onclick="closeClearModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Server list modal -->
  <div id="serverModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–ü—Ä–æ–µ–∫—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h3>
        <div id="serverList" style="max-height:280px; overflow:auto; margin-top:8px"></div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeServerModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error warning modal -->
  <div id="errorWarningModal" class="error-modal" style="display:none">
    <div class="error-modal-backdrop">
      <div class="error-modal-content">
        <div class="error-modal-header">
          <h3>‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h3>
        </div>
        <div class="error-modal-body">
          <div class="issues-summary">
            <div class="issue-count error-count">
              <span class="issue-icon">‚ùå</span>
              <span class="issue-text">–û—à–∏–±–æ–∫: <strong id="errorCount">0</strong></span>
            </div>
            <div class="issue-count warning-count">
              <span class="issue-icon">‚ö†Ô∏è</span>
              <span class="issue-text">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: <strong id="warningCount">0</strong></span>
            </div>
          </div>
          <p>–í –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏.</p>
          <p><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –º–æ–≥—É—Ç –Ω–∞–Ω–µ—Å—Ç–∏ —É—Ä–æ–Ω –∫–æ–º–ø—å—é—Ç–µ—Ä—É –∏–ª–∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.</p>
        </div>
        <div class="error-modal-footer">
          <button class="btn-ghost" onclick="closeErrorWarningModal()">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–¥—É</button>
          <button id="ignoreErrorsBtn" class="btn btn-danger" onclick="ignoreErrorsAndCompile()" disabled>–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (3—Å)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Unknown blocks modal -->
  <div id="unknownBlocksModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–Ω–∞–∫–æ–º—ã–µ –±–ª–æ–∫–∏</h3>
        <div class="small" style="opacity:0.9; margin-bottom:8px">
          –í–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ø–∞–ø–∫–µ <code>mods</code>. –ü—Ä–æ–µ–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é.
        </div>
        <div id="unknownBlocksList" class="small" style="max-height:220px; overflow:auto; padding:8px; border:1px dashed rgba(255,255,255,0.15); border-radius:8px"></div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeUnknownBlocksModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Global ignore confirmation modal -->
  <div id="globalIgnoreModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>–í–Ω–∏–º–∞–Ω–∏–µ: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫</h3>
        <div class="small" style="opacity:0.9; margin-bottom:12px">
          –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö –Ω–∞–Ω–µ—Å—Ç–∏ —É—Ä–æ–Ω –≤–∞—à–µ–º—É –∫–æ–º–ø—å—é—Ç–µ—Ä—É.
        </div>
        <div class="small" style="opacity:0.9; margin-bottom:16px">
          –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeGlobalIgnoreModal()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button id="confirmGlobalIgnoreBtn" class="btn btn-danger" onclick="confirmGlobalIgnore()" disabled>–Ø –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—é (10—Å)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty project warning modal -->
  <div id="emptyProjectModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>‚ö†Ô∏è –ü—Ä–æ–µ–∫—Ç –ø—É—Å—Ç</h3>
        <div style="margin-bottom:16px">
          <p>–í–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</p>
          <p style="color: var(--muted); font-size: 14px; margin-top: 8px;">
            <strong>–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é:</strong> –∑–∞–ø—É—Å–∫, —Å–±–æ—Ä–∫–∞ –≤ .exe –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ .py
          </p>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeEmptyProjectModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- No header blocks warning modal -->
  <div id="noHeaderBlocksModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫ "–ù–∞—á–∞–ª–æ"</h3>
        <div style="margin-bottom:16px">
          <p>–ù–∞ —Ä–∞–±–æ—á–µ–º –ø–æ–ª–µ –Ω–µ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∏ –æ–¥–∏–Ω –±–ª–æ–∫ —Ç–∏–ø–∞ "–ù–∞—á–∞–ª–æ" (header).</p>
          <p style="color: var(--muted); font-size: 14px; margin-top: 8px;">
            –ë–µ–∑ –±–ª–æ–∫–∞ "–ù–∞—á–∞–ª–æ" –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
          </p>
          <p><strong>–£–≤–µ—Ä–µ–Ω—ã –ª–∏ –≤—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å–±–æ—Ä–∫—É?</strong></p>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeNoHeaderBlocksModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn" onclick="confirmCompileWithoutHeader()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–±–æ—Ä–∫—É</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Variable usage history modal -->
  <div id="variableHistoryModal" style="display:none">
    <div class="modal-backdrop">
      <div class="modal" style="max-width:500px">
        <h3 id="variableHistoryTitle">–ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π</h3>
        <div style="margin-bottom:16px">
          <div id="variableHistoryList" style="max-height:400px; overflow:auto; border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:8px;">
            <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
          </div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn-ghost" onclick="closeVariableHistoryModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== State ========== */
let blocksConfig = { categories: [] };
let projectData = { blocks: [], connections: [] };
let enabledMods = {}; // { [modId]: boolean }

// Unsaved changes tracking
let _savedSnapshot = null;
let _pendingAfterUnsavedAction = null; // function to execute after choosing in modal

let dragState = null;           // dragging a block element
let connecting = null;          // creating connection {blockEl, connEl, startX, startY, tempLine}
let camera = { x: 0, y: 0, scale: 1 };    // camera translation
let isPanning = false;
let panStart = null;
let panCameraStart = null;
let contextBlockEl = null;
let contextConnectionEl = null;

// –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª–µ–π value
let valueHistory = new Map(); // –•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
let currentAutocomplete = null; // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
let variableTags = {}; // { variableName: tag }
const TAGS = [
  { key: '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è', icon: 'üî§' },
  { key: '–ú–∞—Å—Å–∏–≤', icon: 'üìö' },
  { key: '–û–±—å–µ–∫—Ç', icon: 'üì¶' },
  { key: '–§—É–Ω–∫—Ü–∏—è', icon: '‚öôÔ∏è' },
  { key: '–¶–≤–µ—Ç', icon: 'üé®' },
  { key: '–ö–æ–Ω—Å—Ç—Ä–∞–Ω—Ç–∞', icon: 'üîí' },
  { key: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö', icon: 'üóÑÔ∏è' },
  { key: '–ö–ª—é—á', icon: 'üîë' }
];

function getTagIcon(tag){
  const t = TAGS.find(t => t.key === tag) || TAGS[0];
  return t.icon;
}

function getVariableTag(name){
  return variableTags[name] || '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è';
}

function setVariableTag(name, tag){
  variableTags[name] = tag;
  try { localStorage.setItem('turtcd_variable_tags', JSON.stringify(variableTags)); } catch(e) {}
  renderVariableRegistry();
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
  if (currentAutocomplete && currentAutocomplete.dropdown) {
    const input = currentAutocomplete.input;
    const suggestions = getSimilarValues(input.value, 8);
    const dropdown = createAutocompleteDropdown(input, suggestions);
    dropdown.style.display = 'block';
  }
}

function loadVariableTags(){
  try {
    const raw = localStorage.getItem('turtcd_variable_tags');
    variableTags = raw ? JSON.parse(raw) : {};
  } catch(e) { variableTags = {}; }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤/–∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –Ω–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
function isValidVariableName(name){
  if (!name || typeof name !== 'string') return false;
  const trimmed = name.trim();
  if (trimmed === '') return false;
  // –ù–ï —Ä–∞–∑—Ä–µ—à–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è (–Ω–æ —Ä–∞–∑—Ä–µ—à–∞—Ç—å –±—É–∫–≤—ã –≤–º–µ—Å—Ç–µ —Å —Ü–∏—Ñ—Ä–∞–º–∏)
  if (/^[\d_]+$/.test(trimmed)) return false;
  // Unicode –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã/–ø–æ–¥—á.
  const pattern = /^[\p{L}\p{N}_]+$/u;
  return pattern.test(trimmed);
}

/* ========== Utils ========== */
function genId(){ return 'b-' + Math.random().toString(36).slice(2,10); }
function el(tag, attrs={}, ...children){
  const e=document.createElement(tag);
  for(const k in attrs){
    if(k === 'className') e.className = attrs[k];
    else if(k === 'onclick') e.setAttribute('onclick', attrs[k]);
    else e[k]=attrs[k];
  }
  children.flat().forEach(c=> typeof c === 'string'? e.appendChild(document.createTextNode(c)) : e.appendChild(c));
  return e;
}

// ========== Unsaved changes helpers ==========
function getProjectSnapshot(){
  // Only persist meaningful, deterministic data for comparison
  const snapshotObj = {
    blocks: projectData.blocks,
    connections: projectData.connections,
    camera: { x: camera.x, y: camera.y, scale: camera.scale },
    variableTags: (typeof variableTags !== 'undefined') ? variableTags : {}
  };
  try {
    return JSON.stringify(snapshotObj);
  } catch(e) {
    return '';
  }
}

function markProjectSaved(){
  _savedSnapshot = getProjectSnapshot();
}

function hasUnsavedChanges(){
  if (_savedSnapshot === null) return true; // if never saved
  return getProjectSnapshot() !== _savedSnapshot;
}
function updateCamera(){ mainCanvas.style.transform = `translate(${camera.x}px,${camera.y}px) scale(${camera.scale})`; }
// –ü—Ä–∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ ¬´—É–µ–∑–∂–∞–ª¬ª
const _origUpdateCamera = updateCamera;
updateCamera = function(){
  _origUpdateCamera();
  if (currentAutocomplete && currentAutocomplete.dropdown && currentAutocomplete.dropdown._positionDropdown) {
    currentAutocomplete.dropdown._positionDropdown();
  }
}

/* ========== –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π value ========== */
function saveValueToHistory(value) {
  if (!value || value.trim() === '') return;
  if (!isValidVariableName(value)) return;
  
  const trimmedValue = value.trim();
  if (valueHistory.has(trimmedValue)) {
    valueHistory.set(trimmedValue, valueHistory.get(trimmedValue) + 1);
  } else {
    valueHistory.set(trimmedValue, 1);
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  localStorage.setItem('turtcd_value_history', JSON.stringify(Array.from(valueHistory.entries())));
}

function loadValueHistory() {
  // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑ –ø–æ–ª–µ–π —Ç–∏–ø–∞ 'value' —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
  valueHistory.clear();
  
  projectData.blocks.forEach(block => {
    const cfg = findCfg(block.template);
    if (!cfg || !cfg.fields || !block.fields) return;
    
    cfg.fields.forEach(f => {
      if (f.type !== 'value') return;
      const v = block.fields[f.name];
      if (!v || typeof v !== 'string') return;
      const trimmedValue = v.trim();
      if (trimmedValue === '') return;
      if (!isValidVariableName(trimmedValue)) return;
      if (valueHistory.has(trimmedValue)) {
        valueHistory.set(trimmedValue, valueHistory.get(trimmedValue) + 1);
      } else {
        valueHistory.set(trimmedValue, 1);
      }
    });
  });

  renderVariableRegistry();
}

function renderVariableRegistry(){
  const container = document.getElementById('variableRegistry');
  if (!container) return;
  container.innerHTML = '';
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
  const entries = Array.from(valueHistory.entries())
    .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
  
  entries.forEach(([name, count]) => {
    const row = el('div', { className: 'var-row' });
    const icon = el('span', { className: 'tag-icon' }, getTagIcon(getVariableTag(name)));
    const n = el('div', { className: 'var-name' }, name);
    const c = el('div', { className: 'var-count' }, `√ó${count}`);
    
    const select = el('select', { className: 'tag-select' });
    TAGS.forEach(t => {
      const opt = el('option', { value: t.key }, t.key);
      if (getVariableTag(name) === t.key) opt.selected = true;
      select.appendChild(opt);
    });
    select.addEventListener('change', (e)=>{
      setVariableTag(name, e.target.value);
    });
    
    // –î–µ–ª–∞–µ–º –∫–ª–∏–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–º –∏—Å—Ç–æ—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    n.style.cursor = 'pointer';
    n.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è';
    n.addEventListener('click', ()=> {
      showVariableHistory(name);
    });
    
    row.appendChild(icon);
    row.appendChild(n);
    row.appendChild(c);
    row.appendChild(select);
    container.appendChild(row);
  });
}

function getSimilarValues(query, limit = 10) {
  if (!query || query.trim() === '') {
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    return Array.from(valueHistory.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, limit)
      .map(([value, count]) => ({ value, count }));
  }
  
  const trimmedQuery = query.trim().toLowerCase();
  const results = [];
  
  for (const [value, count] of valueHistory.entries()) {
    const valueLower = value.toLowerCase();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    if (valueLower.startsWith(trimmedQuery)) {
      results.push({ value, count, similarity: 1.0 });
    }
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
  return results
    .sort((a, b) => b.count - a.count)
    .slice(0, limit)
    .map(({ value, count }) => ({ value, count }));
}

function calculateSimilarity(query, target) {
  if (target.includes(query)) {
    // –¢–æ—á–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ - –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    return 1.0;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏
  if (target.startsWith(query)) {
    return 0.8;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏
  if (target.includes(query)) {
    return 0.6;
  }
  
  // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ö–æ–∂–µ—Å—Ç—å —Å–∏–º–≤–æ–ª–æ–≤
  let matches = 0;
  for (let i = 0; i < Math.min(query.length, target.length); i++) {
    if (query[i] === target[i]) {
      matches++;
    }
  }
  
  return matches / Math.max(query.length, target.length) * 0.4;
}

function createAutocompleteDropdown(input, suggestions) {
  // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π dropdown
  if (currentAutocomplete && currentAutocomplete.dropdown) {
    currentAutocomplete.dropdown.remove();
    currentAutocomplete = null;
  }
  
  if (suggestions.length === 0) {
    return;
  }
  
  const dropdown = el('div', { className: 'autocomplete-dropdown' });
  
  suggestions.forEach((suggestion, index) => {
    const item = el('div', { 
      className: 'autocomplete-item',
      'data-value': suggestion.value,
      'data-index': index
    });
    
    const icon = el('span', { className: 'tag-icon' }, getTagIcon(getVariableTag(suggestion.value)));
    const valueText = el('span', { className: 'value-text' }, suggestion.value);
    const valueCount = el('span', { className: 'value-count' }, `(${suggestion.count})`);
    
    item.appendChild(icon);
    item.appendChild(valueText);
    item.appendChild(valueCount);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
    item.addEventListener('click', () => {
      input.value = suggestion.value;
      input.dispatchEvent(new Event('input', { bubbles: true }));
      hideAutocomplete();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
    item.addEventListener('mouseenter', () => {
      dropdown.querySelectorAll('.autocomplete-item').forEach(el => el.classList.remove('highlighted'));
      item.classList.add('highlighted');
    });
    
    dropdown.appendChild(item);
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º dropdown –∫ body –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  document.body.appendChild(dropdown);
  
  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä—è–¥–æ–º —Å input
  function positionDropdown(){
    const inputRect = input.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const dropdownWidth = 300;
    const dropdownHeight = 200;
    
    // –û—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–ª—è, –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é
    let left = inputRect.right + 8;
    let top = inputRect.top;
    
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä–æ–±—É–µ–º —Å–ª–µ–≤–∞ –æ—Ç –ø–æ–ª—è
    if (left + dropdownWidth > viewportWidth) {
      left = inputRect.left - dropdownWidth - 8;
    }
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–ª–µ–≤–∞ ‚Äî –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
    if (left < 10) left = Math.max(10, viewportWidth - dropdownWidth - 10);
    
    // –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å: –µ—Å–ª–∏ –Ω–∏–∑ –≤—ã–ª–µ–∑–∞–µ—Ç ‚Äî –ø–æ–¥–Ω–∏–º–∞–µ–º; –µ—Å–ª–∏ –≤–µ—Ä—Ö –≤—ã–ª–µ–∑–∞–µ—Ç ‚Äî –æ–ø—É—Å–∫–∞–µ–º
    if (top + dropdownHeight > viewportHeight) top = Math.max(10, viewportHeight - dropdownHeight - 10);
    if (top < 10) top = 10;
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —ç–∫—Ä–∞–Ω–∞
    left = Math.max(10, Math.min(left, viewportWidth - dropdownWidth - 10));
    top = Math.max(10, Math.min(top, viewportHeight - dropdownHeight - 10));
    
    dropdown.style.left = left + 'px';
    dropdown.style.top = top + 'px';
  }
  
  // –ü–µ—Ä–≤–∏—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  positionDropdown();
  
  currentAutocomplete = { input, dropdown };
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  const repositionHandler = () => {
    if (currentAutocomplete && currentAutocomplete.dropdown) positionDropdown();
  };
  
  window.addEventListener('resize', repositionHandler);
  window.addEventListener('scroll', repositionHandler, { passive: true });
  document.addEventListener('mousemove', repositionHandler, { passive: true });
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  dropdown._repositionHandler = repositionHandler;
  dropdown._positionDropdown = positionDropdown;
  
  return dropdown;
}

/* ========== Global ignore helpers ========== */
function isGlobalIgnoreEnabled(){
  return !!(projectData && projectData.globalIgnore === true);
}
function setGlobalIgnoreEnabled(v){
  if (!projectData) return;
  projectData.globalIgnore = !!v;
}
function updateGlobalIgnoreButtonState(){
  const btn = document.getElementById('toggleGlobalIgnoreBtn');
  if (!btn) return;
  const enabled = isGlobalIgnoreEnabled();
  btn.textContent = enabled ? '–í—ã–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫' : '–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏';
}
function toggleGlobalIgnore(){
  const enabled = isGlobalIgnoreEnabled();
  if (!enabled){
    openGlobalIgnoreModal();
  } else {
    // –≤—ã–∫–ª—é—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
    setGlobalIgnoreEnabled(false);
    // —Å–Ω–∏–º–∞–µ–º ignoreIssues —Å–æ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
    projectData.blocks.forEach(b => { b.ignoreIssues = false; });
    updateIssues();
    // –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ ‚Äî —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∏ —Å–æ–æ–±—â–∏—Ç—å
    unlockLockedProblematicBlocksAndReport();
  }
}
function openGlobalIgnoreModal(){
  const modal = document.getElementById('globalIgnoreModal');
  const btn = document.getElementById('confirmGlobalIgnoreBtn');
  if (!modal || !btn) return;
  modal.style.display = 'block';
  let countdown = 10;
  btn.disabled = true;
  btn.textContent = `–Ø –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—é (${countdown}—Å)`;
  if (modal._timer) { clearInterval(modal._timer); }
  modal._timer = setInterval(()=>{
    countdown--;
    if (countdown > 0){
      btn.textContent = `–Ø –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—é (${countdown}—Å)`;
    } else {
      clearInterval(modal._timer);
      modal._timer = null;
      btn.disabled = false;
      btn.textContent = '–Ø –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—é';
    }
  }, 1000);
}
function closeGlobalIgnoreModal(){
  const modal = document.getElementById('globalIgnoreModal');
  if (!modal) return;
  if (modal._timer){ clearInterval(modal._timer); modal._timer = null; }
  modal.style.display = 'none';
}
function confirmGlobalIgnore(){
  // –≤–∫–ª—é—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
  setGlobalIgnoreEnabled(true);
  // –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ–º –±–ª–æ–∫–∞–º ignoreIssues=true
  projectData.blocks.forEach(b => { b.ignoreIssues = true; });
  closeGlobalIgnoreModal();
  updateIssues();
}

 

// –°–Ω–∏–º–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å –±–ª–æ–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –Ω–µ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
function unlockLockedProblematicBlocksAndReport(){
  const panel = document.getElementById('issuesPanel');
  if (!panel) return;
  const problematicIds = new Set();
  panel.querySelectorAll('.issue').forEach(n => {
    const bid = n.dataset && n.dataset.blockId;
    if (bid && !n.classList.contains('ignored')) {
      problematicIds.add(bid);
    }
  });
  let removed = 0;
  problematicIds.forEach(bid => {
    const bd = projectData.blocks.find(b => b.id === bid);
    if (bd && bd.locked){
      bd.locked = false;
      const el = mainCanvas.querySelector(`.block[data-block-id="${bid}"]`);
      if (el) applyBlockLockState(el, bd);
      removed++;
    }
  });
  if (removed > 0){
    showNotification('error', '–°–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫', `–°–Ω—è—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤: ${removed}`);
  } else {
    showNotification('success', '–°–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫', '–°–Ω–∏–º–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å');
  }
}

function showAutocomplete(input) {
  const query = input.value;
  const suggestions = getSimilarValues(query, 8);
  
  if (suggestions.length > 0) {
    const dropdown = createAutocompleteDropdown(input, suggestions);
    dropdown.style.display = 'block';
  }
}

function hideAutocomplete() {
  if (currentAutocomplete && currentAutocomplete.dropdown) {
    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (currentAutocomplete.dropdown._repositionHandler) {
      window.removeEventListener('resize', currentAutocomplete.dropdown._repositionHandler);
      window.removeEventListener('scroll', currentAutocomplete.dropdown._repositionHandler);
    }
    
    currentAutocomplete.dropdown.remove();
    currentAutocomplete = null;
  }
}

function handleAutocompleteKeydown(input, event) {
  if (!currentAutocomplete || !currentAutocomplete.dropdown) return;
  
  const items = currentAutocomplete.dropdown.querySelectorAll('.autocomplete-item');
  const highlighted = currentAutocomplete.dropdown.querySelector('.autocomplete-item.highlighted');
  let currentIndex = highlighted ? parseInt(highlighted.dataset.index) : -1;
  
  switch (event.key) {
    case 'ArrowDown':
      event.preventDefault();
      currentIndex = Math.min(currentIndex + 1, items.length - 1);
      break;
    case 'ArrowUp':
      event.preventDefault();
      currentIndex = Math.max(currentIndex - 1, -1);
      break;
    case 'Enter':
      event.preventDefault();
      if (highlighted) {
        input.value = highlighted.dataset.value;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        hideAutocomplete();
      }
      return;
    case 'Escape':
      event.preventDefault();
      hideAutocomplete();
      return;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
  items.forEach((item, index) => {
    item.classList.toggle('highlighted', index === currentIndex);
  });
}

/* ========== Load blocks config (from server) & render palette ========== */
async function loadBlocksConfig(){
  try {
    const r = await fetch('/api/blocks');
    blocksConfig = await r.json();
  } catch(err){
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å /api/blocks', err);
    // fallback example config so UI is usable
    blocksConfig = {
      categories: [
        { name: '–û—Å–Ω–æ–≤–Ω—ã–µ', collapsed: false, blocks: [
          { id: 'start', name: 'Start', color: '#0ea5a4', type: 'header', width: 220, height: 60, fields: [] },
          { id: 'print', name: 'Print', color: '#8b5cf6', type: 'classic', width: 160, height: 80, fields: [{ name: 'text', label: 'Text' }] },
        ] }
      ]
    };
  }
  renderPalette();
  renderModsPanel();
}
function renderPalette(){
  const root = document.getElementById('categoriesList');
  root.innerHTML = '';
  const activeMods = getEnabledMods();
  blocksConfig.categories.forEach(cat=>{
    const modId = cat.modId || 'core';
    if (activeMods[modId] === false) return; // —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã—Ö –º–æ–¥–æ–≤
    const header = el('div',{className:'category-header'}, el('div',{className:'category-title'}, cat.name), el('div',{className:'collapse-indicator'}, cat.collapsed ? '‚ñ∂' : '‚ñº'));
    const list = el('div',{className:'block-list'});
    if(cat.collapsed) list.style.display='none';
    header.addEventListener('click', ()=>{
      list.style.display = list.style.display === 'none' ? 'block' : 'none';
      const ind = header.querySelector('.collapse-indicator');
      ind.textContent = list.style.display === 'none' ? '‚ñ∂' : '‚ñº';
    });
    cat.blocks.forEach(b=>{
      const item = el('div',{className:'block-item', draggable:true});
      item.dataset.templateId = b.id;
      const dot = el('span',{className:'color-dot'});
      dot.style.background = b.color || '#7f8c8d';
      const name = el('div',{className:'block-name'}, b.name);
      item.appendChild(dot); item.appendChild(name);
      // click create (center-ish)
      item.addEventListener('click', ()=> createFromTemplate(b.id, 200 - camera.x, 200 - camera.y));
      // dragstart - use text/plain for compatibility
      item.addEventListener('dragstart', (ev)=> {
        ev.dataTransfer.setData('text/plain', b.id);
        ev.dataTransfer.effectAllowed = 'copy';
      
      });
    // dragend: no-op cleanup
    item.addEventListener('dragend', ()=>{});
      list.appendChild(item);
    });
    root.appendChild(header);
    root.appendChild(list);
  });
}

/* ========== Mods panel ========== */
function getEnabledMods(){
  if (!Object.keys(enabledMods).length){
    try{
      const raw = localStorage.getItem('turtcd_enabled_mods');
      enabledMods = raw ? JSON.parse(raw) : {};
    }catch(e){ enabledMods = {}; }
  }
  return enabledMods;
}
function setModEnabled(modId, value){
  enabledMods[modId] = value;
  try{ localStorage.setItem('turtcd_enabled_mods', JSON.stringify(enabledMods)); }catch(e){}
  renderModsPanel();
  renderPalette();
  updateGlobalIgnoreButtonState();
}
function summarizeMods(){
  const byMod = {};
  for(const cat of (blocksConfig.categories||[])){
    const modId = cat.modId || 'core';
    const modName = cat.modName || (modId==='core'?'–û—Å–Ω–æ–≤–Ω—ã–µ':'–ú–æ–¥');
    if(!byMod[modId]) byMod[modId] = { modId, modName, groups: 0, blocks: 0 };
    byMod[modId].groups += 1;
    byMod[modId].blocks += (cat.blocks||[]).length;
  }
  return Object.values(byMod).sort((a,b)=> a.modId.localeCompare(b.modId));
}
function renderModsPanel(){
  const panel = document.getElementById('modsPanel'); if(!panel) return;
  const mods = summarizeMods();
  const state = getEnabledMods();
  // ensure every mod has default enabled=true
  mods.forEach(m=>{ if(!(m.modId in state)) state[m.modId] = true; });
  try{ localStorage.setItem('turtcd_enabled_mods', JSON.stringify(state)); }catch(e){}
  panel.innerHTML = '';
  mods.forEach(m=>{
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.justifyContent = 'space-between';
    row.style.padding = '6px 0';
    const info = document.createElement('div');
    info.textContent = `${m.modName} ‚Äî –≥—Ä—É–ø–ø: ${m.groups}, –±–ª–æ–∫–æ–≤: ${m.blocks}`;
    const toggle = document.createElement('label');
    toggle.style.display = 'inline-flex'; 
    toggle.style.alignItems = 'center'; 
    toggle.style.gap = '8px';
    toggle.style.cursor = 'pointer';
    
    // Create toggle switch
    const switchContainer = document.createElement('div');
    switchContainer.style.position = 'relative';
    switchContainer.style.width = '44px';
    switchContainer.style.height = '24px';
    switchContainer.style.backgroundColor = state[m.modId] !== false ? 'var(--accent)' : 'rgba(255,255,255,0.2)';
    switchContainer.style.borderRadius = '12px';
    switchContainer.style.transition = 'background-color 0.3s ease';
    
    const switchThumb = document.createElement('div');
    switchThumb.style.position = 'absolute';
    switchThumb.style.top = '2px';
    switchThumb.style.left = state[m.modId] !== false ? '22px' : '2px';
    switchThumb.style.width = '20px';
    switchThumb.style.height = '20px';
    switchThumb.style.backgroundColor = '#fff';
    switchThumb.style.borderRadius = '50%';
    switchThumb.style.transition = 'left 0.3s ease';
    switchThumb.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    
    switchContainer.appendChild(switchThumb);
    
    const span = document.createElement('span'); 
    span.textContent = state[m.modId] !== false ? '–í–∫–ª' : '–í—ã–∫–ª';
    span.style.fontSize = '12px';
    span.style.fontWeight = '500';
    
    // Add click handler
    toggle.addEventListener('click', (e) => {
      e.preventDefault();
      const newState = !(state[m.modId] !== false);
      setModEnabled(m.modId, newState);
      
      // Update visual state
      switchContainer.style.backgroundColor = newState ? 'var(--accent)' : 'rgba(255,255,255,0.2)';
      switchThumb.style.left = newState ? '22px' : '2px';
      span.textContent = newState ? '–í–∫–ª' : '–í—ã–∫–ª';
    });
    toggle.appendChild(switchContainer); 
    toggle.appendChild(span);
    row.appendChild(info); 
    row.appendChild(toggle);
    panel.appendChild(row);
  });
}

/* ========== Canvas & block creation ========== */
const mainCanvas = document.getElementById('mainCanvas');
 

function createFromTemplate(templateId, x, y){
  const cfg = findCfg(templateId); if(!cfg) return;
  const id = genId();
  const block = {
    id, template: cfg.id, type: cfg.type,
    x: Math.round(x), y: Math.round(y),
    width: cfg.width || 160, height: cfg.height || 80,
    fields: {},
    fieldTypes: {}, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø—ã –ø–æ–ª–µ–π
    ignoreIssues: isGlobalIgnoreEnabled() ? true : false
  };
  if(cfg.fields) {
    cfg.fields.forEach(f => {
      block.fields[f.name] = '';
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –ø–æ–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ
      block.fieldTypes[f.name] = 'single-line';
    });
  }
  projectData.blocks.push(block);
  createInstance(block);
  updateCounts();
  updateConnections();
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π
  loadValueHistory();
}
function findCfg(templateId){
  for(const cat of blocksConfig.categories) for(const b of cat.blocks) if(b.id===templateId) return b;
  return null;
}

function createInstance(blockData){
  const cfg = findCfg(blockData.template);
  const wrapper = el('div', { className: 'block' });
  wrapper.style.left = blockData.x + 'px';
  wrapper.style.top = blockData.y + 'px';
  wrapper.style.background = cfg?.color || '#2a4f6b';
  wrapper.dataset.blockId = blockData.id;
  wrapper.dataset.blockType = blockData.type || (cfg && cfg.type) || 'classic';

  const header = el('div', { className: 'block-header' }, cfg?.name || ('Block ' + blockData.template));
  const content = el('div', { className: 'block-content' });

  // indicator (top-right)
  const indicator = el('div', { className: 'block-indicator' });
  indicator.setAttribute('aria-hidden', 'true');

  // lock indicator (top-right)
  const lockIndicator = el('div', { className: 'block-lock-indicator', title: '–ë–ª–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' }, 'üîí');
  lockIndicator.style.position = 'absolute';
  lockIndicator.style.top = '6px';
  lockIndicator.style.right = '6px';
  lockIndicator.style.width = '18px';
  lockIndicator.style.height = '18px';
  lockIndicator.style.display = 'none';
  lockIndicator.style.alignItems = 'center';
  lockIndicator.style.justifyContent = 'center';
  lockIndicator.style.fontSize = '12px';
  lockIndicator.style.background = 'rgba(0,0,0,0.35)';
  lockIndicator.style.borderRadius = '4px';
  lockIndicator.style.pointerEvents = 'none';

  if(cfg && cfg.fields && cfg.fields.length){
    cfg.fields.forEach(f=>{
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–ª—è: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–æ–µ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ
      const isMultiLine = blockData.fieldTypes && blockData.fieldTypes[f.name] === 'multi-line';
      const inputType = isMultiLine ? 'textarea' : 'input';
      const inputClass = isMultiLine ? 'field-input multi-line' : 'field-input single-line';
      
      const input = el(inputType, { 
        className: inputClass, 
        placeholder: f.placeholder || f.label || f.name, 
        value: blockData.fields[f.name] || '' 
      });
      if (blockData.locked) { input.disabled = true; }
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è textarea
      function autoResize(textarea) {
        if (textarea.tagName === 'TEXTAREA') {
          textarea.style.height = 'auto';
          const newHeight = Math.min(textarea.scrollHeight, 200);
          textarea.style.height = newHeight + 'px';
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –≤ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞
          if (!blockData.fieldHeights) {
            blockData.fieldHeights = {};
          }
          blockData.fieldHeights[f.name] = newHeight;
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è textarea)
      if (input.tagName === 'TEXTAREA') {
        if (blockData.fieldHeights && blockData.fieldHeights[f.name]) {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É
          const savedHeight = blockData.fieldHeights[f.name];
          input.style.height = Math.min(savedHeight, 200) + 'px';
        } else {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä
          autoResize(input);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        let resizeTimeout;
        const saveHeight = () => {
          const currentHeight = parseInt(input.style.height) || input.offsetHeight;
          if (!blockData.fieldHeights) {
            blockData.fieldHeights = {};
          }
          blockData.fieldHeights[f.name] = currentHeight;
        };
        
        input.addEventListener('resize', saveHeight);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞
        input.addEventListener('mouseup', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(saveHeight, 100);
        });
      }
      
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π —Å —Ç–∏–ø–æ–º 'value'
      if (f.type === 'value') {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º
        let autocompleteTimeout;
        input.addEventListener('input', (e)=> {
          blockData.fields[f.name] = e.target.value;
          autoResize(e.target);
          updateCounts();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
          loadValueHistory();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
          clearTimeout(autocompleteTimeout);
          autocompleteTimeout = setTimeout(() => {
            if (e.target.value.length > 0) {
              showAutocomplete(e.target);
            } else {
              hideAutocomplete();
            }
          }, 300);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞
        input.addEventListener('focus', (e) => {
          if (e.target.value.length > 0) {
            showAutocomplete(e.target);
          }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
        input.addEventListener('blur', (e) => {
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å
          setTimeout(() => {
            hideAutocomplete();
          }, 150);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
        input.addEventListener('keydown', (e) => {
          handleAutocompleteKeydown(e.target, e);
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        input.addEventListener('blur', (e) => {
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
          loadValueHistory();
        });
      } else {
        // –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
        input.addEventListener('input', (e)=> {
          blockData.fields[f.name] = e.target.value;
          autoResize(e.target);
          updateCounts();
          // –ò—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –Ω–µ-value –ø–æ–ª–µ–π
        });
      }
      
      content.appendChild(input);
    });
  } else {
    content.appendChild(el('div',{className:'small'}, cfg?.type || ''));
  }

  // connectors
  if(!cfg || cfg.type !== 'header') wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-top' }));
  wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-bottom' }));
  // right connector for branching/loop blocks
  if(cfg && (cfg.type === 'condition' || cfg.type === 'loop')) wrapper.appendChild(Object.assign(document.createElement('div'), { className: 'connector connector-right' }));

  wrapper.appendChild(indicator);
  wrapper.appendChild(lockIndicator);
  wrapper.appendChild(header);
  wrapper.appendChild(content);

  // drag move block (start only when click NOT on input and NOT on connector)
  wrapper.addEventListener('mousedown', (ev)=>{
    // if user clicked on input or contenteditable or on connector - don't start move
    const target = ev.target;
    if(target.closest('input,textarea,[contenteditable="true"]')) return;
    if(target.closest('.connector')) return;
    // if block locked - do not allow move
    if (blockData.locked) return;
    // if Ctrl key is pressed - do not allow move (for camera panning)
    if (ev.ctrlKey) return;
    // start dragging
    document.body.style.userSelect = 'none';
    const rect = wrapper.getBoundingClientRect();
    dragState = { el: wrapper, startX: ev.clientX, startY: ev.clientY, left: parseFloat(wrapper.style.left || 0), top: parseFloat(wrapper.style.top || 0) };
  });

  mainCanvas.appendChild(wrapper);
  // apply initial lock state
  applyBlockLockState(wrapper, blockData);
}

/* ========== Drag move handler & camera ========== */
document.addEventListener('mousemove', (e)=>{
  // dragging a block
  if(dragState){
    const dx = e.clientX - dragState.startX, dy = e.clientY - dragState.startY;
    const nx = dragState.left + dx, ny = dragState.top + dy;
    dragState.el.style.left = nx + 'px'; dragState.el.style.top = ny + 'px';
    const bid = dragState.el.dataset.blockId;
    const bd = projectData.blocks.find(b => b.id === bid);
    if(bd){ bd.x = nx; bd.y = ny; }
    updateConnections();
    return; // when dragging block don't pan or update connecting line separately here
  }

  // panning camera
  if(isPanning){
    const dx = e.clientX - panStart.x, dy = e.clientY - panStart.y;
    camera.x = panCameraStart.x + dx; camera.y = panCameraStart.y + dy;
    updateCamera();
    updateConnections();
    return;
  }

  // updating connecting temp-line
  if(connecting){
    const rect = mainCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const dx = mx - connecting.startX, dy = my - connecting.startY;
    const len = Math.sqrt(dx*dx + dy*dy);
    const ang = Math.atan2(dy,dx);
    connecting.tempLine.style.width = Math.max(len,2) + 'px';
    connecting.tempLine.style.transform = `rotate(${ang}rad)`;
  }
});

// mouseup / end interactions
document.addEventListener('mouseup', (e)=>{
  // stop dragging
  dragState = null;
  // stop panning
  isPanning = false;
  panStart = null;
  panCameraStart = null;

  // cleanup connecting if not finished (if there is a connecting temporary line and mouseup outside connector)
  if(connecting && connecting.tempLine){
    connecting.tempLine.remove();
    connecting = null;
  }
  // restore selection
  document.body.style.userSelect = '';
});

// when leaving viewport, cancel panning
document.getElementById('viewport').addEventListener('mouseleave', ()=>{
  isPanning = false;
  panStart = null;
  panCameraStart = null;
});

/* ========== Connecting blocks (temp line & finalize) ========== */
mainCanvas.addEventListener('mousedown', (e)=>{
  const conn = e.target.closest('.connector');
  if(!conn) return;
  e.preventDefault();
  // disable text selection while creating connection
  document.body.style.userSelect = 'none';
  const blockEl = conn.closest('.block');
  const crect = conn.getBoundingClientRect(), canv = mainCanvas.getBoundingClientRect();
  const startX = crect.left + crect.width/2 - canv.left;
  const startY = crect.top + crect.height/2 - canv.top;
  const tempLine = document.createElement('div');
  tempLine.className = 'connection-line temp-line';
  tempLine.style.left = startX + 'px';
  tempLine.style.top = startY + 'px';
  tempLine.style.width = '0px';
  tempLine.style.transform = 'rotate(0rad)';
  mainCanvas.appendChild(tempLine);
  connecting = { blockEl, connEl: conn, startX, startY, tempLine };
});
mainCanvas.addEventListener('mouseup', (e)=>{
  if(!connecting) return;
  let targetConn = e.target.closest('.connector');
  // If mouseup happened on a block (but not exactly on a connector), snap to its top connector
  if(!targetConn){
    const hoveredBlock = e.target.closest('.block');
    if(hoveredBlock && hoveredBlock !== connecting.blockEl){
      targetConn = hoveredBlock.querySelector('.connector-top');
    }
  }
  if(targetConn){
    const toBlock = targetConn.closest('.block');
    if(toBlock && toBlock !== connecting.blockEl){
      const fromId = connecting.blockEl.dataset.blockId, toId = toBlock.dataset.blockId;
      const fromC = connectorType(connecting.connEl), toC = connectorType(targetConn);
      if(allowedConnect(fromC, toC)){
        projectData.connections.push({ 
          from: fromId, 
          to: toId, 
          fromConnector: fromC, 
          toConnector: toC,
          color: 'system'
        });
        updateConnections();
      }
    }
  }
  // cleanup temp
  if(connecting?.tempLine) connecting.tempLine.remove();
  connecting = null;
  // restore selection
  document.body.style.userSelect = '';
});

/* connector helpers */
function connectorType(el){
  if(el.classList.contains('connector-top')) return 'top';
  if(el.classList.contains('connector-bottom')) return 'bottom';
  if(el.classList.contains('connector-right')) return 'right';
  return '';
}
function allowedConnect(from, to){ return (['bottom','right'].includes(from) && ['top'].includes(to)); }

/* ========== Render connections ========== */
function updateConnections(){
  // remove old visuals (except temp-line)
  mainCanvas.querySelectorAll('.connection-line:not(.temp-line), .connection-point').forEach(n=>n.remove());
  // iterate
  projectData.connections.forEach(c=>{
    const fromEl = mainCanvas.querySelector(`.block[data-block-id="${c.from}"]`);
    const toEl = mainCanvas.querySelector(`.block[data-block-id="${c.to}"]`);
    if(!fromEl || !toEl) return;
    const fromConn = fromEl.querySelector(`.connector-${c.fromConnector}`);
    const toConn = toEl.querySelector(`.connector-${c.toConnector}`);
    if(!fromConn || !toConn) return;
    const p1 = connectorCenterInCanvas(fromConn);
    const p2 = connectorCenterInCanvas(toConn);
    const dx = p2.x - p1.x, dy = p2.y - p1.y;
    const len = Math.sqrt(dx*dx + dy*dy), ang = Math.atan2(dy,dx);
    const line = document.createElement('div'); 
    line.className = 'connection-line';
    line.style.left = p1.x + 'px'; 
    line.style.top = p1.y + 'px';
    line.style.width = Math.max(len,2) + 'px'; 
    line.style.transform = `rotate(${ang}rad)`;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const color = c.color || 'system';
    line.classList.add(`color-${color}`);
    
    // attach dataset for identification
    line.dataset.key = `${c.from}->${c.to}:${c.fromConnector}->${c.toConnector}`;
    mainCanvas.appendChild(line);
    // mid point clickable for deletion
    const mx = p1.x + dx/2, my = p1.y + dy/2;
    const point = document.createElement('div'); point.className = 'connection-point';
    point.style.left = (mx - 6) + 'px'; point.style.top = (my - 6) + 'px';
    point.dataset.key = line.dataset.key;
    point.addEventListener('contextmenu', (ev)=>{ 
      ev.preventDefault(); 
      contextConnectionEl = point;
      showConnectionContextMenu(ev);
    });
    mainCanvas.appendChild(point);
  });
  updateCounts();
}
function connectorCenterInCanvas(connEl){
  const r = connEl.getBoundingClientRect(), c = mainCanvas.getBoundingClientRect();
  return { x: r.left + r.width/2 - c.left, y: r.top + r.height/2 - c.top };
}

 

/* ========== Camera pan (Ctrl + LMB) ========== */
document.getElementById('viewport').addEventListener('mousedown', (e)=>{
  // start panning with Ctrl + LMB
  if(e.button===0 && e.ctrlKey){
    isPanning = true;
    panStart = { x: e.clientX, y: e.clientY };
    panCameraStart = { x: camera.x, y: camera.y };
    e.preventDefault();
  }
});
window.addEventListener('keyup', (e)=>{ if(e.key === 'Control') { isPanning = false; panStart = null; panCameraStart = null; } });

/* ========== Drag & Drop from palette anywhere on page ========== */
document.addEventListener('dragover', (e)=>{ e.preventDefault(); });
document.addEventListener('drop', (e)=>{
  e.preventDefault();
  const templateId = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('templateId');
  if(!templateId) return;
  const viewportRect = document.getElementById('viewport').getBoundingClientRect();
  const vx = e.clientX - viewportRect.left;
  const vy = e.clientY - viewportRect.top;
  const x = vx - camera.x;
  const y = vy - camera.y;
  createFromTemplate(templateId, x, y);
  updateConnections();
});

/* ========== Context menu actions ========== */
document.addEventListener('contextmenu', (e)=>{
  const block = e.target.closest('.block');
  const menu = document.getElementById('blockContextMenu');
  if(block){
    e.preventDefault();
    contextBlockEl = block;
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.style.display = 'block';
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
    try {
      const id = contextBlockEl?.dataset?.blockId;
      const bd = projectData.blocks.find(b => b.id === id);
      const item = document.getElementById('ignoreIssueMenuItem');
      if (item) {
        const isIgnored = !!(bd && bd.ignoreIssues === true);
        item.textContent = (isIgnored ? 'üî¥ –û—Ç–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞' : 'üü¢ –í–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞');
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      const lockItem = document.getElementById('lockMenuItem');
      const allItems = Array.from(menu.querySelectorAll('.menu-item'));
      if (lockItem && bd){
        const locked = !!bd.locked;
        lockItem.textContent = locked ? 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫';
        if (locked){
          // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É –ø—É—Ç–∏ –∏ –ø—É–Ω–∫—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
          allItems.forEach(mi => {
            if (mi.id === 'blockPathInfo' || mi.id === 'lockMenuItem') mi.style.display = 'block';
            else mi.style.display = 'none';
          });
        } else {
          // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø—É–Ω–∫—Ç—ã
          allItems.forEach(mi => { mi.style.display = 'block'; });
        }
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ –ø—É—Ç–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –±–ª–æ–∫–∞
      const info = document.getElementById('blockPathInfo');
      if (info && bd) {
        const cfg = findCfg(bd.template);
        let catName = '';
        let modText = '';
        for (const cat of (blocksConfig.categories||[])){
          if ((cat.blocks||[]).some(cb => cb.id === (cfg && cfg.id))) {
            catName = cat.name || '';
            const modId = cat.modId || 'core';
            const modName = cat.modName || (modId==='core' ? '' : modId);
            if (modId !== 'core') modText = ` ¬∑ –∏–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${modName}`;
            break;
          }
        }
        const blockName = (cfg && cfg.name) ? cfg.name : (bd.template || '–ë–ª–æ–∫');
        info.textContent = `${catName ? catName + ' > ' : ''}${blockName}${modText}`;
      }
    } catch(_) {}
  } else {
    menu.style.display = 'none';
    contextBlockEl = null;
  }
});
document.addEventListener('click', ()=> { 
  document.getElementById('blockContextMenu').style.display='none';
  hideConnectionContextMenu();
  // –°–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  hideAutocomplete();
});

async function duplicateContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  const bd = projectData.blocks.find(b => b.id === id);
  if(!bd) return;
  try {
    const resp = await fetch('/api/block/duplicate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ block_data: bd })});
    const j = await resp.json();
    if(j.status === 'success' && j.new_block){
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –Ω–æ–≤–æ–º—É –±–ª–æ–∫—É, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
      if (isGlobalIgnoreEnabled()) {
        j.new_block.ignoreIssues = true;
      }
      projectData.blocks.push(j.new_block);
      createInstance(j.new_block);
      updateConnections();
      updateCounts();
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π
      loadValueHistory();
    } else alert('–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
  } catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è'); }
  document.getElementById('blockContextMenu').style.display='none';
}

function deleteContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  projectData.blocks = projectData.blocks.filter(b => b.id !== id);
  projectData.connections = projectData.connections.filter(c => c.from !== id && c.to !== id);
  const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
  if(el) el.remove();
  updateConnections();
  updateCounts();
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π
  loadValueHistory();
  document.getElementById('blockContextMenu').style.display='none';
}

function toggleFieldInputType(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  const blockData = projectData.blocks.find(b => b.id === id);
  if(!blockData) return;
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º fieldTypes –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  if (!blockData.fieldTypes) {
    blockData.fieldTypes = {};
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∏–ø –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤ –±–ª–æ–∫–µ
  const cfg = findCfg(blockData.template);
  if (cfg && cfg.fields && cfg.fields.length) {
    cfg.fields.forEach(f => {
      const currentType = blockData.fieldTypes[f.name] || 'single-line';
      blockData.fieldTypes[f.name] = currentType === 'single-line' ? 'multi-line' : 'single-line';
    });
  }
  
  // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –Ω–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏ –ø–æ–ª–µ–π
  const blockEl = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
  if (blockEl) {
    blockEl.remove();
  }
  createInstance(blockData);
  updateConnections();
  updateCounts();
  
  document.getElementById('blockContextMenu').style.display='none';
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
function toggleIgnoreIssuesForContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  const bd = projectData.blocks.find(b => b.id === id);
  if(!bd) return;
  bd.ignoreIssues = !bd.ignoreIssues;
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É–Ω–∫—Ç –º–µ–Ω—é
  const item = document.getElementById('ignoreIssueMenuItem');
  if (item) {
    item.textContent = (bd.ignoreIssues ? 'üî¥ –û—Ç–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞' : 'üü¢ –í–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞');
  }
  // –ü–µ—Ä–µ—Å—á—ë—Ç –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–Ω–µ–ª—å–∫–∏ –ø—Ä–æ–±–ª–µ–º
  updateIssues();
  document.getElementById('blockContextMenu').style.display='none';
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–ª–æ–∫–∞ (–∑–∞–ø—Ä–µ—Ç –Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π)
function toggleLockForContextBlock(){
  if(!contextBlockEl) return;
  const id = contextBlockEl.dataset.blockId;
  const bd = projectData.blocks.find(b => b.id === id);
  if(!bd) return;
  // –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –Ω–µ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö –ø—Ä–æ–±–ª–µ–º
  if (!bd.locked){
    const hasBlockingIssues = hasUnignoredIssuesForBlock(id);
    if (hasBlockingIssues){
      showNotification('error', '–ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫', '–ë–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ.');
      const menu = document.getElementById('blockContextMenu');
      if (menu) menu.style.display='none';
      return;
    }
  }
  bd.locked = !bd.locked;
  const blockEl = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
  if (blockEl) applyBlockLockState(blockEl, bd);
  const menu = document.getElementById('blockContextMenu');
  if (menu) menu.style.display='none';
}

// –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π
function applyBlockLockState(blockEl, blockData){
  const lockEl = blockEl.querySelector('.block-lock-indicator');
  const inputs = blockEl.querySelectorAll('input, textarea');
  const isLocked = !!blockData.locked;
  if (lockEl){
    lockEl.style.display = isLocked ? 'flex' : 'none';
  }
  inputs.forEach(inp => { inp.disabled = isLocked; });
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
  blockEl.querySelectorAll('textarea').forEach(ta => {
    ta.style.resize = isLocked ? 'none' : '';
  });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —É –±–ª–æ–∫–∞ –Ω–µ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–æ—à–∏–±–∫–∏/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
function hasUnignoredIssuesForBlock(blockId){
  const panel = document.getElementById('issuesPanel');
  if (!panel) return false;
  const nodes = Array.from(panel.querySelectorAll('.issue'));
  // –ò—â–µ–º –∑–∞–ø–∏—Å–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É –±–ª–æ–∫—É (–ø–æ data-block-id), –∏—Å–∫–ª—é—á–∞—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ
  return nodes.some(n => n.dataset && n.dataset.blockId === blockId && !n.classList.contains('ignored'));
}

/* ========== Connection context menu functions ========== */
function showConnectionContextMenu(event) {
  const menu = document.getElementById('connectionContextMenu');
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
  menu.style.display = 'block';
}

function hideConnectionContextMenu() {
  const menu = document.getElementById('connectionContextMenu');
  menu.style.display = 'none';
  contextConnectionEl = null;
}

function deleteConnection() {
  if (!contextConnectionEl) return;
  
  const key = contextConnectionEl.dataset.key;
  projectData.connections = projectData.connections.filter(c => 
    `${c.from}->${c.to}:${c.fromConnector}->${c.toConnector}` !== key
  );
  
  updateConnections();
  updateCounts();
  hideConnectionContextMenu();
}

function changeConnectionColor(color) {
  if (!contextConnectionEl) return;
  
  const key = contextConnectionEl.dataset.key;
  const connection = projectData.connections.find(c => 
    `${c.from}->${c.to}:${c.fromConnector}->${c.toConnector}` === key
  );
  
  if (connection) {
    connection.color = color;
    updateConnections();
  }
  
  hideConnectionContextMenu();
}

/* ========== Export / Import / Save to server / Load from server ========== */
function openExportModal(){ document.getElementById('exportModal').style.display = 'block'; }
function closeExportModal(){ document.getElementById('exportModal').style.display = 'none'; }
async function confirmExportTurtcd(){
  const name = (document.getElementById('exportFilename').value || 'project').trim();
  // –í–∫–ª—é—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã –∏ —Ç–µ–≥–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —ç–∫—Å–ø–æ—Ä—Ç
  const projectDataWithCamera = {
    ...projectData,
    camera: { x: camera.x, y: camera.y, scale: camera.scale },
    variableTags: variableTags
  };
  const data = JSON.stringify(projectDataWithCamera, null, 2);

  // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å File System Access API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
  try {
    if (window.showSaveFilePicker) {
      const handle = await window.showSaveFilePicker({
        suggestedName: name + '.turtcd',
        types: [{ description: 'TurtCD Project', accept: { 'application/json': ['.turtcd'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(new Blob([data], { type: 'application/json' }));
      await writable.close();
      closeExportModal();
      showNotification && showNotification('success', '–≠–∫—Å–ø–æ—Ä—Ç', '–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      // –≠–∫—Å–ø–æ—Ä—Ç –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      markProjectSaved();
      return;
    }
  } catch(e) {
    console.warn('File System Access API error', e);
  }

  // –§–æ–ª–ª–±—ç–∫: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name + '.turtcd';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  closeExportModal();
  // –≠–∫—Å–ø–æ—Ä—Ç –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  markProjectSaved();
}

async function saveProject(){
  const currentProject = localStorage.getItem('currentProject');
  if (!currentProject) {
    showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç.');
    return;
  }
  
  try {
    // –í–∫–ª—é—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã –∏ —Ç–µ–≥–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
    const projectDataWithCamera = {
      ...projectData,
      camera: {
        x: camera.x,
        y: camera.y,
        scale: camera.scale
      },
      variableTags: variableTags
    };
    
    const resp = await fetch('/api/project/save-file', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ 
        filename: currentProject, 
        project_data: projectDataWithCamera 
      })
    });
    const j = await resp.json();
    if(j.status === 'success') { 
      showNotification('success', '–£—Å–ø–µ—Ö', '–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ' + currentProject);
      markProjectSaved();
    } else {
      showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (j.message || 'unknown'));
    }
  } catch(err){ 
    showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
  }
}

function importFromFile(ev){
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const parsed = JSON.parse(e.target.result);
      if(parsed && parsed.blocks){
        loadProjectFromObject(parsed);
      } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
    } catch(err){ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message); }
  };
  reader.readAsText(f);
  // reset
  ev.target.value = '';
}

function loadProjectFromObject(obj){
  // clear canvas
  mainCanvas.querySelectorAll('.block').forEach(n=>n.remove());
  projectData = obj;
  // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ
  if (typeof projectData.globalIgnore === 'undefined') {
    projectData.globalIgnore = false;
  }

  // –û–±–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
  try {
    updateGlobalIgnoreButtonState && updateGlobalIgnoreButtonState();
  } catch(_) {}
  
  // –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ - –¥–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  if (projectData.connections) {
    projectData.connections.forEach(connection => {
      if (!connection.color) connection.color = 'system';
    });
  }
  
  // –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º fieldTypes
  if (projectData.blocks) {
    projectData.blocks.forEach(block => {
      if (!block.fieldTypes) {
        block.fieldTypes = {};
        // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –ø–æ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const cfg = findCfg(block.template);
        if (cfg && cfg.fields) {
          cfg.fields.forEach(f => {
            block.fieldTypes[f.name] = 'single-line';
          });
        }
      }
    });
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–≥–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ
  if (obj.variableTags) {
    variableTags = obj.variableTags;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    try { 
      localStorage.setItem('turtcd_variable_tags', JSON.stringify(variableTags)); 
    } catch(e) {}
  }
  
  // create instances
  projectData.blocks.forEach(b => createInstance(b));
  updateConnections();
  updateCounts();
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
  loadValueHistory();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
  if (obj.camera) {
    camera.x = obj.camera.x || 0;
    camera.y = obj.camera.y || 0;
    camera.scale = obj.camera.scale || 1;
    updateCamera();
  }

  // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º
  markProjectSaved();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–∑–Ω–∞–∫–æ–º—ã–µ –±–ª–æ–∫–∏
  try {
    const unknown = [];
    for (const b of (projectData.blocks || [])) {
      if (!findCfg(b.template)) {
        unknown.push(b.template);
      }
    }
    if (unknown.length) {
      showUnknownBlocksModal(Array.from(new Set(unknown)));
    }
  } catch(e) { console.warn('Unknown blocks check failed', e); }
}

/* Server save modal */
function openSaveModal(){ document.getElementById('saveModal').style.display = 'block'; }
function closeSaveModal(){ document.getElementById('saveModal').style.display = 'none'; }
async function saveToServer(){
  const filename = document.getElementById('saveFilename').value.trim();
  if(!filename){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞'); return; }
  try {
    const resp = await fetch('/api/project/save-file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: filename + '.turtcd', project_data: projectData })});
    const j = await resp.json();
    if(j.status === 'success') { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + j.filename); closeSaveModal(); }
    else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message); }
}

/* Server list */
async function showServerProjects(){
  try {
    const r = await fetch('/api/project/list');
    const j = await r.json();
    if(j.status !== 'success'){ alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞'); return; }
    const listDiv = document.getElementById('serverList');
    listDiv.innerHTML = '';
    if(j.projects.length === 0) listDiv.appendChild(el('div', {}, '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤'));
    j.projects.forEach(fn => {
      const row = el('div', {}, fn);
      row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center'; row.style.padding = '6px 0';
      const btn = document.createElement('button');
      btn.className = 'btn-ghost';
      btn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
      btn.addEventListener('click', ()=> loadProjectFromServer(fn));
      row.appendChild(btn);
      listDiv.appendChild(row);
    });
    document.getElementById('serverModal').style.display = 'block';
  } catch(err){ alert('–û—à–∏–±–∫–∞: ' + err.message); }
}
function closeServerModal(){ document.getElementById('serverModal').style.display = 'none'; }
async function loadProjectFromServer(filename){
  try {
    const resp = await fetch('/api/project/load-file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename })});
    const j = await resp.json();
    if(j.status === 'success' && j.project_data){
      loadProjectFromObject(j.project_data);
      closeServerModal();
    } else alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message); }
}

/* ========== Compile ========== */
async function compileProject(){
  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π
  await saveProject();
  
  // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É...');
  console.log('–ë–ª–æ–∫–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ:', projectData.blocks.length);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—É—Å—Ç–æ–π –ø—Ä–æ–µ–∫—Ç
  if (isProjectEmpty()) {
    console.log('–ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º');
    showEmptyProjectModal();
    return;
  }
  
  console.log('–ü—Ä–æ–µ–∫—Ç –Ω–µ –ø—É—Å—Ç–æ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º header –±–ª–æ–∫–∏...');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ header –±–ª–æ–∫–æ–≤
  if (!hasHeaderBlocks()) {
    console.log('Header –±–ª–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    showNoHeaderBlocksModal();
    return;
  }
  
  console.log('Header –±–ª–æ–∫–∏ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏...');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
  const issues = checkForIssues();
  if (issues.hasIssues) {
    console.log('–ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:', issues);
    showErrorWarningModal(issues);
    return;
  }
  
  console.log('–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –∫–æ–º–ø–∏–ª—è—Ü–∏—é...');
  
  // –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
  await performCompilation();
}

function checkForIssues() {
  const panel = document.getElementById('issuesPanel');
  if (!panel) return { hasIssues: false, warnings: 0, errors: 0 };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∫–ª–∞—Å—Å–∞–º–∏ issue warning –∏–ª–∏ issue error
  const warnings = panel.querySelectorAll('.issue.warning');
  const errors = panel.querySelectorAll('.issue.error');
  
  return {
    hasIssues: warnings.length > 0 || errors.length > 0,
    warnings: warnings.length,
    errors: errors.length
  };
}

function showErrorWarningModal(issues) {
  const modal = document.getElementById('errorWarningModal');
  const ignoreBtn = document.getElementById('ignoreErrorsBtn');
  const errorCountEl = document.getElementById('errorCount');
  const warningCountEl = document.getElementById('warningCount');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
  errorCountEl.textContent = issues.errors;
  warningCountEl.textContent = issues.warnings;
  
  modal.style.display = 'flex';
  ignoreBtn.disabled = true;
  ignoreBtn.textContent = '–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (3—Å)';
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
  let countdown = 3;
  const timer = setInterval(() => {
    countdown--;
    if (countdown > 0) {
      ignoreBtn.textContent = `–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (${countdown}—Å)`;
    } else {
      ignoreBtn.disabled = false;
      ignoreBtn.textContent = '–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å';
      clearInterval(timer);
    }
  }, 1000);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
  modal._timer = timer;
}

function closeErrorWarningModal() {
  const modal = document.getElementById('errorWarningModal');
  if (modal._timer) {
    clearInterval(modal._timer);
    modal._timer = null;
  }
  modal.style.display = 'none';
}

/* Unknown blocks modal */
function showUnknownBlocksModal(ids){
  const box = document.getElementById('unknownBlocksList');
  box.innerHTML = '';
  if (ids && ids.length){
    const ul = document.createElement('ul');
    ul.style.margin = '0';
    ul.style.paddingLeft = '18px';
    ids.forEach(id=>{
      const li = document.createElement('li');
      li.textContent = id;
      ul.appendChild(li);
    });
    box.appendChild(ul);
  } else {
    box.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.';
  }
  document.getElementById('unknownBlocksModal').style.display = 'block';
}
function closeUnknownBlocksModal(){
  document.getElementById('unknownBlocksModal').style.display = 'none';
}

async function ignoreErrorsAndCompile() {
  closeErrorWarningModal();
  await performCompilation();
}

async function performCompilation() {
  try {
    const resp = await fetch('/api/project/compile', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ project_data: projectData })
    });
    const j = await resp.json();
    if(j.status === 'success'){
      localStorage.setItem("compiled_code", j.code || "# –ø—É—Å—Ç–æ");
      window.location.href = "/compiled.html";
    } else alert('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: ' + (j.message || 'unknown'));
  } catch(err){ alert('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: ' + err.message); }
}

/* ========== Empty project checks ========== */
function isProjectEmpty() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±–ª–æ–∫–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ
  if (!projectData.blocks || projectData.blocks.length === 0) {
    console.log('–ù–µ—Ç –±–ª–æ–∫–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
    return true;
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ –æ–Ω
  const generatedCode = generatePythonCodeFromProject();
  console.log('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:', generatedCode);
  const isEmpty = isCodeEmpty(generatedCode);
  console.log('–ö–æ–¥ –ø—É—Å—Ç–æ–π?', isEmpty);
  return isEmpty;
}

function isCodeEmpty(code) {
  if (!code || code.trim() === '') {
    return true;
  }
  
  // –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
  const lines = code.split('\n').map(line => line.trim()).filter(line => 
    line !== '' && !line.startsWith('#') && !line.startsWith('"""') && !line.startsWith("'''")
  );
  
  return lines.length === 0;
}

function hasHeaderBlocks() {
  if (!projectData.blocks || projectData.blocks.length === 0) {
    return false;
  }
  
  return projectData.blocks.some(block => block.type === 'header');
}

function generatePythonCodeFromProject() {
  if (!projectData.blocks || projectData.blocks.length === 0) {
    return "";
  }

  const blocks = {};
  for (const b of projectData.blocks) {
    blocks[b.id] = b;
  }
  const connections = projectData.connections || [];
  const outgoing = {};
  for (const conn of connections) {
    if (!outgoing[conn.from]) {
      outgoing[conn.from] = [];
    }
    outgoing[conn.from].push(conn);
  }

  const visited = new Set();
  const codeLines = [];

  function compileBlock(blockId, indent = 0) {
    if (visited.has(blockId)) {
      return;
    }
    visited.add(blockId);
    const block = blocks[blockId];
    if (!block) {
      return;
    }
    const blockCfg = findCfg(block.template);
    if (!blockCfg) {
      return;
    }
    let code = blockCfg.code || '';
    for (const [n, v] of Object.entries(block.fields || {})) {
      code = code.replace(`{${n}}`, String(v || ""));
    }
    if (code.trim()) {
      // –†–∞–∑–±–∏–≤–∞–µ–º –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
      const lines = code.trim().split('\n');
      for (const line of lines) {
        if (line.trim()) { // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
          codeLines.push("    ".repeat(indent) + line);
        }
      }
    }
    if (blockCfg.type === 'condition' || blockCfg.type === 'loop') {
      const body = outgoing[blockId]?.find(c => c.fromConnector === 'right');
      if (body) {
        compileBlock(body.to, indent + 1);
      }
      const nxt = outgoing[blockId]?.find(c => c.fromConnector === 'bottom');
      if (nxt) {
        compileBlock(nxt.to, indent);
      }
    } else {
      const nxt = outgoing[blockId]?.find(c => c.fromConnector === 'bottom');
      if (nxt) {
        compileBlock(nxt.to, indent);
      }
    }
  }

  const start = Object.values(blocks).find(b => b.type === 'header');
  if (start) {
    compileBlock(start.id, 0);
  }
  return codeLines.join('\n');
}

/* ========== Modal handlers ========== */
function showEmptyProjectModal() {
  document.getElementById('emptyProjectModal').style.display = 'block';
}

function closeEmptyProjectModal() {
  document.getElementById('emptyProjectModal').style.display = 'none';
}

function showNoHeaderBlocksModal() {
  document.getElementById('noHeaderBlocksModal').style.display = 'block';
}

function closeNoHeaderBlocksModal() {
  document.getElementById('noHeaderBlocksModal').style.display = 'none';
}

async function confirmCompileWithoutHeader() {
  closeNoHeaderBlocksModal();
  await performCompilation();
}

/* ========== Variable history modal handlers ========== */
function showVariableHistory(varName){
  const modal = document.getElementById('variableHistoryModal');
  const title = document.getElementById('variableHistoryTitle');
  const list = document.getElementById('variableHistoryList');
  if (!modal || !title || !list) return;
  
  title.textContent = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π "${varName}"`;
  list.innerHTML = '';
  
  // –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –±–ª–æ–∫–æ–≤
  function buildExecutionOrder() {
    const order = [];
    const visited = new Set();
    const outgoing = {};
    
    // –ü–æ—Å—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å —Å–≤—è–∑–µ–π
    projectData.connections.forEach(c => {
      if (!outgoing[c.from]) outgoing[c.from] = [];
      outgoing[c.from].push(c);
    });
    
    // –ù–∞–π–¥–µ–º header –±–ª–æ–∫
    const headers = projectData.blocks.filter(b => b.type === 'header');
    if (headers.length === 0) return order;
    
    function traverse(blockId) {
      if (visited.has(blockId)) return;
      visited.add(blockId);
      order.push(blockId);
      
      const connections = outgoing[blockId] || [];
      connections.sort((a, b) => {
        // –°–Ω–∞—á–∞–ª–∞ bottom/right, –ø–æ—Ç–æ–º –¥—Ä—É–≥–∏–µ
        const priority = { 'bottom': 1, 'right': 2, 'top': 3, 'left': 4 };
        return (priority[a.fromConnector] || 99) - (priority[b.fromConnector] || 99);
      });
      
      connections.forEach(c => {
        if (c.fromConnector === 'bottom' || c.fromConnector === 'right') {
          traverse(c.to);
        }
      });
    }
    
    headers.forEach(h => traverse(h.id));
    return order;
  }
  
  const executionOrder = buildExecutionOrder();
  
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  const usages = [];
  projectData.blocks.forEach(b => {
    const cfg = findCfg(b.template);
    if (!cfg || !cfg.fields || !b.fields) return;
    
    cfg.fields.forEach(f => {
      if (f.type === 'value' && b.fields[f.name] && b.fields[f.name] === varName) {
        const blockName = cfg.name || b.template;
        const order = executionOrder.indexOf(b.id);
        usages.push({
          blockId: b.id,
          blockName: blockName,
          fieldLabel: f.label || f.name,
          fieldName: f.name,
          order: order >= 0 ? order : 999999 // –ë–ª–æ–∫–∏ –±–µ–∑ –ø–æ—Ä—è–¥–∫–∞ –∏–¥—É—Ç –≤ –∫–æ–Ω–µ—Ü
        });
      }
    });
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ—Ä—è–¥–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  usages.sort((a, b) => a.order - b.order);
  
  if (usages.length === 0){
    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);">–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ</div>';
  } else {
    usages.forEach((usage, idx) => {
      const item = el('div', {
        className: 'variable-history-item',
        style: 'padding:10px; margin:4px 0; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;'
      });
      
      const textContent = `<div><strong>${usage.blockName}</strong> ‚Äî ${usage.fieldLabel}${idx === 0 ? ' <span style="color:#22c55e; font-size:11px; background:rgba(34,197,94,0.1); padding:2px 6px; border-radius:4px;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span>' : ''}</div>`;
      item.innerHTML = textContent;
      
      item.addEventListener('mouseenter', () => {
        item.style.background = 'rgba(255,255,255,0.1)';
      });
      item.addEventListener('mouseleave', () => {
        item.style.background = 'rgba(255,255,255,0.05)';
      });
      item.addEventListener('click', () => {
        navigateToVariableUsage(usage.blockId, usage.fieldName);
        closeVariableHistoryModal();
      });
      list.appendChild(item);
    });
  }
  
  modal.style.display = 'block';
}

function closeVariableHistoryModal(){
  const modal = document.getElementById('variableHistoryModal');
  if (modal) modal.style.display = 'none';
}

function navigateToVariableUsage(blockId, fieldName){
  // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞–º–µ—Ä—É –∫ –±–ª–æ–∫—É
  moveCameraToBlock(blockId);
  
  // –ù–∞—Ö–æ–¥–∏–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ
  setTimeout(() => {
    const blockEl = mainCanvas.querySelector(`.block[data-block-id="${blockId}"]`);
    if (!blockEl) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const input = blockEl.querySelector(`input[value="${fieldName}"], textarea`);
    if (!input) return;
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ
    input.style.backgroundColor = 'rgba(14, 165, 233, 0.3)';
    input.style.boxShadow = '0 0 16px rgba(14, 165, 233, 0.6)';
    input.style.transition = 'all 0.3s ease';
    
    setTimeout(() => {
      input.style.backgroundColor = '';
      input.style.boxShadow = '';
      setTimeout(() => {
        input.style.transition = '';
      }, 300);
    }, 2000);
  }, 200);
}

/* ========== –ü—Ä–æ–≤–µ—Ä–∫–∏: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏ ========== */
function updateIssues(){
  const panel = document.getElementById('issuesPanel');
  if(!panel) return;
  panel.innerHTML = '';
  // clear previous highlights
  mainCanvas.querySelectorAll('.block').forEach(el=>{ el.classList.remove('block-warning','block-error'); });
  // clear previous indicators
  mainCanvas.querySelectorAll('.block .block-indicator').forEach(ind=>{ ind.style.display='none'; ind.classList.remove('indicator-warning','indicator-error'); ind.textContent=''; });

  // collect per-block statuses
  const warningBlocks = new Set();
  const errorBlocks = new Set();

  function isIgnored(blockId){
    if(!blockId) return false;
    const b = projectData.blocks.find(bb => bb.id === blockId);
    return !!(b && b.ignoreIssues === true);
  }

  // Buckets to control final ordering: ignored ‚Üí errors ‚Üí warnings
  const ignoredIssueNodes = [];
  const errorIssueNodes = [];
  const warningIssueNodes = [];

  // Helper to create styled message blocks
  function addWarning(text, blockId = null){
    const ignored = isIgnored(blockId);
    const node = document.createElement('div');
    node.className = ignored ? 'issue ignored' : 'issue warning';
    if(blockId){ node.dataset.blockId = blockId; }
    if(blockId) {
      node.style.cursor = 'pointer';
      node.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É';
    }
    const ic = document.createElement('div'); ic.className = 'icon';
    if(ignored){
      ic.textContent = '?';
      ic.style.background = '#16a34a';
      ic.style.color = '#ffffff';
      ic.style.borderRadius = '999px';
      ic.style.fontWeight = '400';
    } else {
      ic.textContent = '!';
    }
    node.appendChild(ic);
    const txt = document.createElement('div');
    if(ignored){
      // –ö—Ä–∞—Ç–∫–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö
      const b = projectData.blocks.find(bb => bb.id === blockId);
      const cfg = b ? findCfg(b.template) : null;
      const displayName = (cfg && cfg.name) ? cfg.name : (b ? b.id : '');
      txt.textContent = `–û—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ "${displayName}"`;
      txt.style.color = '#22c55e';
    } else {
      txt.textContent = '–ù–ï–°–û–û–¢–í–ï–¢–°–í–ò–ï! ' + text;
    }
    node.appendChild(txt);
    if(blockId) {
      node.addEventListener('click', () => moveCameraToBlock(blockId));
    }
    if(ignored) ignoredIssueNodes.push(node); else warningIssueNodes.push(node);
    return ignored;
  }
  function addError(text, blockId = null){
    const ignored = isIgnored(blockId);
    const node = document.createElement('div');
    node.className = ignored ? 'issue ignored' : 'issue error';
    if(blockId){ node.dataset.blockId = blockId; }
    if(blockId) {
      node.style.cursor = 'pointer';
      node.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É';
    }
    const ic = document.createElement('div'); ic.className = 'icon';
    if(ignored){
      ic.textContent = '?';
      ic.style.background = '#16a34a';
      ic.style.color = '#ffffff';
      ic.style.borderRadius = '999px';
      ic.style.fontWeight = '400';
    } else {
      ic.textContent = '‚úï';
    }
    node.appendChild(ic);
    const txt = document.createElement('div');
    if(ignored){
      const b = projectData.blocks.find(bb => bb.id === blockId);
      const cfg = b ? findCfg(b.template) : null;
      const displayName = (cfg && cfg.name) ? cfg.name : (b ? b.id : '');
      txt.textContent = `–û—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ "${displayName}"`;
      txt.style.color = '#22c55e';
    } else {
      txt.textContent = '–û–®–ò–ë–ö–ê! ' + text;
    }
    node.appendChild(txt);
    if(blockId) {
      node.addEventListener('click', () => moveCameraToBlock(blockId));
    }
    if(ignored) ignoredIssueNodes.push(node); else errorIssueNodes.push(node);
    return ignored;
  }

  // 1) –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è value
  projectData.blocks.forEach(b=>{
    const cfg = findCfg(b.template);
    if(cfg && cfg.fields && cfg.fields.length){
      cfg.fields.forEach(f=>{
        const val = (b.fields && (b.fields[f.name] !== undefined)) ? b.fields[f.name] : '';
        if(f.type === 'value') {
          const valStr = String(val);
          if(!valStr || valStr.trim() === '') {
            const ignored = addWarning(`–í –±–ª–æ–∫ "${cfg.name || b.template}" ‚Äî –ø–æ–ª–µ "${f.label || f.name}" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ`, b.id);
            if(!ignored) warningBlocks.add(b.id);
          } else if (/\s/.test(valStr)) {
            const ignored = addError(`–í –±–ª–æ–∫–µ "${cfg.name || b.template}" ‚Äî –ø–æ–ª–µ "${f.label || f.name}" –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã!`, b.id);
            if(!ignored) errorBlocks.add(b.id);
          } else if (/^[\d_]+$/.test(valStr)) {
            const ignored = addError(`–í –±–ª–æ–∫–µ "${cfg.name || b.template}" ‚Äî –ø–æ–ª–µ "${f.label || f.name}" –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä –∏–ª–∏ _!`, b.id);
            if(!ignored) errorBlocks.add(b.id);
          }
        } else {
          if(!val || String(val).trim() === '') {
            const ignored = addWarning(`–í –±–ª–æ–∫ "${cfg.name || b.template}" ‚Äî –ø–æ–ª–µ "${f.label || f.name}" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ`, b.id);
            if(!ignored) warningBlocks.add(b.id);
          }
        }
      });
    }
  });

  // 2) More than 1 header block -> error
  const headers = projectData.blocks.filter(b => b.type === 'header');
  if(headers.length > 1){
    addError(`–í —Å—Ö–µ–º–µ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ —Ç–∏–ø–∞ header (${headers.length})`);
    headers.forEach(h=> {
      const ignored = addError(`–î—É–±–ª–∏—Ä—É—é—â–∏–π –±–ª–æ–∫ header`, h.id);
      if(!ignored) errorBlocks.add(h.id);
    });
  }

  // 3) Connector having more than 1 connection (either incoming or outgoing) -> error
  const connCountMap = {}; // key -> count, key = blockId + ':' + connector
  projectData.connections.forEach(c=>{
    const kFrom = `${c.from}:${c.fromConnector}`;
    const kTo = `${c.to}:${c.toConnector}`;
    connCountMap[kFrom] = (connCountMap[kFrom]||0) + 1;
    connCountMap[kTo] = (connCountMap[kTo]||0) + 1;
  });
  for(const key in connCountMap){
    if(connCountMap[key] > 1){
      // parse key
      const [bid, conn] = key.split(':');
      const blk = projectData.blocks.find(bb => bb.id === bid);
      const blkName = (blk && findCfg(blk.template) && findCfg(blk.template).name) ? findCfg(blk.template).name : (blk ? blk.id : bid);
      const ignored = addError(`–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä "${conn}" —É –±–ª–æ–∫–∞ "${blkName}" –∏–º–µ–µ—Ç ${connCountMap[key]} —Å–≤—è–∑–µ–π`, bid);
      if(blk && !ignored) errorBlocks.add(blk.id);
    }
  }

  // 4) Blocks with no incoming connections -> warning (except header blocks which may be start)
  projectData.blocks.forEach(b=>{
    const hasIncoming = projectData.connections.some(c => c.to === b.id);
    if(!hasIncoming && b.type !== 'header'){
      const cfg = findCfg(b.template);
      const displayName = (cfg && cfg.name) ? cfg.name : b.id;
      const ignored = addWarning(`–í –±–ª–æ–∫ "${displayName}" –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∏ –æ–¥–Ω–∞ —Å–≤—è–∑—å`, b.id);
      if(!ignored) warningBlocks.add(b.id);
    }
  });

  // 5) Cycles and conditions without right connector connections -> warning
  projectData.blocks.forEach(b=>{
    if(b.type === 'loop' || b.type === 'condition'){
      const hasRightConnection = projectData.connections.some(c => c.from === b.id && c.fromConnector === 'right');
      if(!hasRightConnection){
        const cfg = findCfg(b.template);
        const displayName = (cfg && cfg.name) ? cfg.name : b.id;
        const ignored = addWarning(`–£ –±–ª–æ–∫–∞ "${displayName}" (${b.type === 'loop' ? '—Ü–∏–∫–ª' : '—É—Å–ª–æ–≤–∏–µ'}) –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–≤—è–∑—å –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞`, b.id);
        if(!ignored) warningBlocks.add(b.id);
      }
    }
  });

  // Append issues in requested order: ignored ‚Üí errors ‚Üí warnings
  ignoredIssueNodes.forEach(n => panel.appendChild(n));
  errorIssueNodes.forEach(n => panel.appendChild(n));
  warningIssueNodes.forEach(n => panel.appendChild(n));

  // If panel is empty, show a small "–≤—Å–µ —Ö–æ—Ä–æ—à–æ"
  if(panel.children.length === 0){
    const ok = document.createElement('div');
    ok.className = 'small';
    ok.style.opacity = '0.7';
    ok.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Äî –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ—Ç.';
    panel.appendChild(ok);
  }

  // apply highlights (errors override warnings)
  warningBlocks.forEach(id=>{
    if(!errorBlocks.has(id)){
      const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
      if(el) {
        el.classList.add('block-warning');
        const ind = el.querySelector('.block-indicator');
        if(ind){ ind.style.display='flex'; ind.classList.add('indicator-warning'); ind.textContent='!'; }
      }
    }
  });
  errorBlocks.forEach(id=>{
    const el = mainCanvas.querySelector(`.block[data-block-id="${id}"]`);
    if(el){
      el.classList.remove('block-warning');
      el.classList.add('block-error');
      const ind = el.querySelector('.block-indicator');
      if(ind){ ind.style.display='flex'; ind.classList.add('indicator-error'); ind.textContent='‚úï'; }
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
  updateGlobalIgnoreButtonState();
}

/* ========== Camera movement to block ========== */
function moveCameraToBlock(blockId) {
  const blockEl = mainCanvas.querySelector(`.block[data-block-id="${blockId}"]`);
  if (!blockEl) return;
  
  const blockData = projectData.blocks.find(b => b.id === blockId);
  if (!blockData) return;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã viewport
  const viewport = document.getElementById('viewport');
  const viewportRect = viewport.getBoundingClientRect();
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä viewport
  const viewportCenterX = viewportRect.width / 2;
  const viewportCenterY = viewportRect.height / 2;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –±–ª–æ–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
  const blockX = blockData.x;
  const blockY = blockData.y;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–º–µ—Ä—ã –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
  const newCameraX = viewportCenterX - blockX;
  const newCameraY = viewportCenterY - blockY;
  
  // –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞–º–µ—Ä—É
  camera.x = newCameraX;
  camera.y = newCameraY;
  updateCamera();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç - –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –±–ª–æ–∫
  blockEl.style.transform = 'scale(1.1)';
  blockEl.style.transition = 'transform 0.3s ease';
  
  setTimeout(() => {
    blockEl.style.transform = 'scale(1)';
    setTimeout(() => {
      blockEl.style.transition = '';
    }, 300);
  }, 1000);
}

/* ========== Small helpers ========== */
function updateCounts(){
  document.getElementById('blocksCount').textContent = projectData.blocks.length;
  document.getElementById('connsCount').textContent = projectData.connections.length;
  updateIssues();
}



/* ========== Custom dialogs ========== */
function showCustomPrompt(title, message, callback, defaultValue = '') {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="margin-bottom: 12px; color: var(--muted);">${message}</div>
        <input type="text" class="custom-input" id="customPromptInput" value="${defaultValue}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="handleCustomPrompt(true)">–û–ö</button>
        <button class="btn-ghost" onclick="handleCustomPrompt(false)">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // –§–æ–∫—É—Å –Ω–∞ input
  setTimeout(() => {
    const input = document.getElementById('customPromptInput');
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –∏ Escape
  const handleKeydown = (e) => {
    if (e.key === 'Enter') {
      handleCustomPrompt(true);
    } else if (e.key === 'Escape') {
      handleCustomPrompt(false);
    }
  };
  
  document.addEventListener('keydown', handleKeydown);
  
  window.handleCustomPrompt = (confirmed) => {
    const input = document.getElementById('customPromptInput');
    const value = input ? input.value.trim() : '';
    
    document.body.removeChild(modal);
    document.removeEventListener('keydown', handleKeydown);
    delete window.handleCustomPrompt;
    
    if (confirmed && value) {
      callback(value);
    }
  };
}

function showCustomConfirm(title, message, callback) {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="color: var(--white);">${message}</div>
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="handleCustomConfirm(true)">–î–∞</button>
        <button class="btn-ghost" onclick="handleCustomConfirm(false)">–ù–µ—Ç</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  window.handleCustomConfirm = (confirmed) => {
    document.body.removeChild(modal);
    delete window.handleCustomConfirm;
    
    if (confirmed) {
      callback();
    }
  };
}

function showCustomAlert(title, message) {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = `
    <div class="custom-modal-content">
      <div class="custom-modal-header">${title}</div>
      <div class="custom-modal-body">
        <div style="color: var(--white);">${message}</div>
      </div>
      <div class="custom-modal-footer">
        <button class="btn" onclick="closeCustomAlert()">–û–ö</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  window.closeCustomAlert = () => {
    document.body.removeChild(modal);
    delete window.closeCustomAlert;
  };
}

function goToProjectSelection() {
  // Check unsaved changes
  if (hasUnsavedChanges()) {
    _pendingAfterUnsavedAction = () => { window.location.href = '/'; };
    openUnsavedChangesModal();
    return;
  }
  window.location.href = '/';
}

function openUnsavedChangesModal(){
  const m = document.getElementById('unsavedChangesModal');
  if (!m) return;
  m.style.display = 'block';
}

function closeUnsavedChangesModal(){
  const m = document.getElementById('unsavedChangesModal');
  if (!m) return;
  m.style.display = 'none';
}

async function confirmUnsavedSave(){
  try {
    await saveProject();
    closeUnsavedChangesModal();
    const next = _pendingAfterUnsavedAction; _pendingAfterUnsavedAction = null;
    if (typeof next === 'function') next();
  } catch(e) {
    // –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
  }
}

function confirmUnsavedDiscard(){
  closeUnsavedChangesModal();
  const next = _pendingAfterUnsavedAction; _pendingAfterUnsavedAction = null;
  if (typeof next === 'function') next();
}

/* ========== Custom notifications ========== */
function showNotification(type, title, message, duration = 4000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <button class="notification-close" onclick="closeNotification(this)">√ó</button>
    <div class="notification-header">
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
      <span class="notification-title">${title}</span>
    </div>
    <div class="notification-message">${message}</div>
  `;
  
  document.body.appendChild(notification);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
  setTimeout(() => {
    closeNotification(notification.querySelector('.notification-close'));
  }, duration);
}

function closeNotification(closeButton) {
  const notification = closeButton.closest('.notification');
  notification.classList.remove('show');
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 300);
}


/* ========== Theme management ========== */
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('turtcd-theme', theme);
  
  // Update theme dropdown
  const dropdown = document.getElementById('themeDropdown');
  if (dropdown) {
    dropdown.value = theme;
  }
}

function loadTheme() {
  const savedTheme = localStorage.getItem('turtcd-theme') || 'dark';
  setTheme(savedTheme);
}

/* ========== Clear workspace ========== */
function openClearModal(){ document.getElementById('clearModal').style.display = 'block'; }
function closeClearModal(){ document.getElementById('clearModal').style.display = 'none'; }
function confirmClearWorkspace() {
  // Clear canvas
  mainCanvas.querySelectorAll('.block').forEach(n => n.remove());
  
  // Reset project data
  projectData = { blocks: [], connections: [] };
  
  // Update counts and connections
  updateConnections();
  updateCounts();
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π
  loadValueHistory();
  closeClearModal();
}

/* ========== Load current project ========== */
async function loadCurrentProject() {
  const currentProject = localStorage.getItem('currentProject');
  if (currentProject) {
    try {
      const resp = await fetch('/api/project/load-file', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ filename: currentProject })
      });
      const j = await resp.json();
      if(j.status === 'success' && j.project_data){
        loadProjectFromObject(j.project_data);
      }
    } catch(err){ 
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', err); 
    }
  }
}

/* ========== Help Tour System ========== */
let helpTour = {
  isActive: false,
  currentStep: 0,
  steps: [],
  overlay: null,
  spotlight: null,
  tooltip: null
};

// –®–∞–≥–∏ —ç–∫—Å–∫—É—Ä—Å–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –±–ª–æ–∫–æ–≤
const editorSteps = [
  {
    target: '.left h2',
    title: '–ü–∞–ª–∏—Ç—Ä–∞ –±–ª–æ–∫–æ–≤',
    content: '–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º. –ë–ª–æ–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞.',
    position: 'right'
  },
  {
    target: '.left .btn',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º',
    content: '–ö–Ω–æ–ø–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞. –≠–∫—Å–ø–æ—Ä—Ç —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª .turtcd, –∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.',
    position: 'right'
  },
  {
    target: '.left .btn-ghost',
    title: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏',
    content: '–ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ" —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –±–ª–æ–∫–∏ —Å —Ä–∞–±–æ—á–µ–≥–æ –ø–æ–ª—è. –ö–Ω–æ–ø–∫–∞ "–ò–º–ø–æ—Ä—Ç" –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ñ–∞–π–ª–∞.',
    position: 'right'
  },
  {
    target: '.center .toolbar .btn',
    title: '–ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞',
    content: '–ö–Ω–æ–ø–∫–∞ "–°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å" –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤–∞—à–∏ –±–ª–æ–∫–∏ –≤ Python –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å.',
    position: 'bottom'
  },
  {
    target: '.center .toolbar .btn-ghost',
    title: '–ù–∞–≤–∏–≥–∞—Ü–∏—è',
    content: '–ö–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ö–Ω–æ–ø–∫–∞ "–ü–æ–º–æ—â—å" –∑–∞–ø—É—Å–∫–∞–µ—Ç —ç—Ç–æ—Ç —ç–∫—Å–∫—É—Ä—Å.',
    position: 'bottom'
  },
  {
    target: '#viewport',
    title: '–†–∞–±–æ—á–µ–µ –ø–æ–ª–µ',
    content: '–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –±–ª–æ–∫–∏ —Å—é–¥–∞ –∏ —Å–æ–µ–¥–∏–Ω—è–π—Ç–µ –∏—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.',
    position: 'top'
  },
  {
    target: '.right-panel .panel-title',
    title: '–ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
    content: '–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –∏ —Å–≤—è–∑–µ–π. –¢–∞–∫–∂–µ –∑–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏.',
    position: 'left'
  },
  {
    target: '#variableRegistry',
    title: '–†–µ–µ—Å—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö',
    content: '–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–º–∞—Å—Å–∏–≤, –æ–±—ä–µ–∫—Ç, —Ñ—É–Ω–∫—Ü–∏—è –∏ —Ç.–¥.).',
    position: 'left'
  },
  {
    target: '#modsPanel',
    title: '–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏',
    content: '–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è TurtCD. –í–∫–ª—é—á–∞–π—Ç–µ –Ω—É–∂–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.',
    position: 'left'
  }
];

function startHelpTour() {
  if (helpTour.isActive) {
    return;
  }

  helpTour.isActive = true;
  helpTour.currentStep = 0;
  helpTour.steps = editorSteps;

  createHelpOverlay();
  showHelpStep(0);
}

function createHelpOverlay() {
  // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  helpTour.overlay = document.createElement('div');
  helpTour.overlay.className = 'help-tour-overlay';
  document.body.appendChild(helpTour.overlay);

  // –°–æ–∑–¥–∞–µ–º spotlight
  helpTour.spotlight = document.createElement('div');
  helpTour.spotlight.className = 'help-tour-spotlight';
  helpTour.overlay.appendChild(helpTour.spotlight);

  // –°–æ–∑–¥–∞–µ–º tooltip
  helpTour.tooltip = document.createElement('div');
  helpTour.tooltip.className = 'help-tour-tooltip';
  helpTour.overlay.appendChild(helpTour.tooltip);
}

function showHelpStep(stepIndex) {
  if (stepIndex >= helpTour.steps.length) {
    endHelpTour();
    return;
  }

  // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  document.querySelectorAll('.help-tour-highlighted').forEach(el => {
    el.classList.remove('help-tour-highlighted');
  });

  const step = helpTour.steps[stepIndex];
  const targetElement = document.querySelector(step.target);

  if (!targetElement) {
    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —à–∞–≥
    showHelpStep(stepIndex + 1);
    return;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
  targetElement.classList.add('help-tour-highlighted');

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
  if (stepIndex >= 1 && stepIndex <= 2) { // –®–∞–≥–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –æ—á–∏—Å—Ç–∫–∏
    const leftPanel = document.querySelector('.left');
    if (leftPanel) {
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤ —Å–∞–º—ã–π –Ω–∏–∑ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
      leftPanel.scrollTop = leftPanel.scrollHeight;
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      setTimeout(() => {
        positionElements();
      }, 100);
      return;
    }
  }

  positionElements();

  function positionElements() {
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º spotlight
    const rect = targetElement.getBoundingClientRect();
    helpTour.spotlight.style.left = (rect.left - 8) + 'px';
    helpTour.spotlight.style.top = (rect.top - 8) + 'px';
    helpTour.spotlight.style.width = (rect.width + 16) + 'px';
    helpTour.spotlight.style.height = (rect.height + 16) + 'px';

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º tooltip
    positionTooltip(step, rect);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ tooltip
    helpTour.tooltip.innerHTML = `
      <h3>${step.title}</h3>
      <p>${step.content}</p>
      <div class="help-actions">
        ${stepIndex > 0 ? '<button class="btn-ghost" onclick="previousHelpStep()">‚Üê –ù–∞–∑–∞–¥</button>' : ''}
        <button class="btn-ghost" onclick="endHelpTour()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="btn" onclick="nextHelpStep()">${stepIndex === helpTour.steps.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–î–∞–ª–µ–µ ‚Üí'}</button>
      </div>
      <div class="help-tour-progress">${stepIndex + 1} –∏–∑ ${helpTour.steps.length}</div>
    `;

    helpTour.currentStep = stepIndex;
  }
}

function positionTooltip(step, targetRect) {
  const tooltip = helpTour.tooltip;
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  const tooltipWidth = 350;
  const tooltipHeight = 200;
  const margin = 20;

  let left, top;

  switch (step.position) {
    case 'top':
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.top - tooltipHeight - margin;
      break;
    case 'bottom':
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.bottom + margin;
      break;
    case 'left':
      left = targetRect.left - tooltipWidth - margin;
      top = targetRect.top + (targetRect.height / 2) - (tooltipHeight / 2);
      break;
    case 'right':
      left = targetRect.right + margin;
      top = targetRect.top + (targetRect.height / 2) - (tooltipHeight / 2);
      break;
    default:
      left = targetRect.left + (targetRect.width / 2) - (tooltipWidth / 2);
      top = targetRect.bottom + margin;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã viewport
  if (left < margin) left = margin;
  if (left + tooltipWidth > viewportWidth - margin) left = viewportWidth - tooltipWidth - margin;
  if (top < margin) top = targetRect.bottom + margin;
  if (top + tooltipHeight > viewportHeight - margin) top = targetRect.top - tooltipHeight - margin;

  tooltip.style.left = Math.max(0, left) + 'px';
  tooltip.style.top = Math.max(0, top) + 'px';
}

function nextHelpStep() {
  showHelpStep(helpTour.currentStep + 1);
}

function previousHelpStep() {
  if (helpTour.currentStep > 0) {
    showHelpStep(helpTour.currentStep - 1);
  }
}

function endHelpTour() {
  // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  document.querySelectorAll('.help-tour-highlighted').forEach(el => {
    el.classList.remove('help-tour-highlighted');
  });

  if (helpTour.overlay) {
    helpTour.overlay.remove();
  }
  helpTour.isActive = false;
  helpTour.currentStep = 0;
  helpTour.overlay = null;
  helpTour.spotlight = null;
  helpTour.tooltip = null;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —ç–∫—Å–∫—É—Ä—Å—É
document.addEventListener('keydown', function(e) {
  if (!helpTour.isActive) return;

  switch (e.key) {
    case 'Escape':
      endHelpTour();
      break;
    case 'ArrowRight':
    case ' ':
      e.preventDefault();
      nextHelpStep();
      break;
    case 'ArrowLeft':
      e.preventDefault();
      previousHelpStep();
      break;
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã (Ctrl + —Å—Ç—Ä–µ–ª–æ—á–∫–∏)
document.addEventListener('keydown', function(e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∂–∞—Ç Ctrl –∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω —ç–∫—Å–∫—É—Ä—Å
  if (!e.ctrlKey || helpTour.isActive) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ–∫—É—Å –Ω–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  const activeElement = document.activeElement;
  if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.contentEditable === 'true')) {
    return;
  }
  
  const moveStep = 50; // –®–∞–≥ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö
  
  switch (e.key) {
    case 'ArrowUp':
      e.preventDefault();
      camera.y += moveStep;
      updateCamera();
      updateConnections();
      break;
    case 'ArrowDown':
      e.preventDefault();
      camera.y -= moveStep;
      updateCamera();
      updateConnections();
      break;
    case 'ArrowLeft':
      e.preventDefault();
      camera.x += moveStep;
      updateCamera();
      updateConnections();
      break;
    case 'ArrowRight':
      e.preventDefault();
      camera.x -= moveStep;
      updateCamera();
      updateConnections();
      break;
  }
});

/* ========== Init ========== */
(async function init(){
  await loadBlocksConfig();
  loadTheme();
  loadValueHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  await loadCurrentProject();
  // apply camera transform
  updateCamera();
  updateCounts();
  updateGlobalIgnoreButtonState();
})();
</script>
</body>
<!-- License badge -->
<div style="position: fixed; right: 12px; top: 10px; z-index: 10060; font-size: 12px; font-weight: 700; color: var(--white); background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.12); padding: 6px 10px; border-radius: 10px; backdrop-filter: blur(2px); user-select: none; pointer-events: none;">
  üõ° licensed by TurtCD
</div>
</html>